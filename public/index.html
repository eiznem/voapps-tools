<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VoApps Tools v3.2.0</title>
  <style>
    :root {
      --success: #16a34a;
      --success-hover: #15803d;
      --primary: #FF4B7D;
      --primary-hover: #E63B6D;
      --sidebar-width: 60px;
      --header-height: 56px;
      --footer-height: 56px;
      --left-panel-width: 50%;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f7;
      color: #2E2C3E;
      line-height: 1.6;
      height: 100vh;
      overflow: hidden;
    }

    /* ==========================================
       MAIN LAYOUT
       ========================================== */

    .app-container {
      display: flex;
      height: 100vh;
    }

    /* LEFT SIDEBAR */
    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, #2E2C3E 0%, #1a1a2e 100%);
      display: flex;
      flex-direction: column;
      border-right: 1px solid #3a3a4a;
      z-index: 100;
    }

    .sidebar-logo {
      height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #3a3a4a;
      padding: 12px;
    }

    .sidebar-logo svg {
      width: 32px;
      height: 32px;
    }

    .sidebar-nav {
      flex: 1;
      padding: 12px 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 44px;
      margin: 0 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      color: #FBF7F3;
      opacity: 0.6;
    }

    .sidebar-item:hover {
      background: rgba(255, 75, 125, 0.1);
      opacity: 1;
      color: #FF4B7D;
    }

    .sidebar-item.active {
      background: rgba(255, 75, 125, 0.15);
      opacity: 1;
      color: #FF4B7D;
    }

    .sidebar-item.active::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 24px;
      background: #FF4B7D;
      border-radius: 0 3px 3px 0;
    }

    .sidebar-item svg {
      width: 20px;
      height: 20px;
      fill: #FBF7F3;
    }

    .sidebar-item:hover svg,
    .sidebar-item.active svg {
      fill: #FF4B7D;
    }

    .sidebar-item-tooltip {
      position: absolute;
      left: calc(var(--sidebar-width) + 8px);
      background: #2E2C3E;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 1000;
    }

    .sidebar-item:hover .sidebar-item-tooltip {
      opacity: 1;
    }

    .sidebar-footer {
      padding: 12px;
      border-top: 1px solid #3a3a4a;
    }

    .sidebar-version {
      font-size: 9px;
      color: #FBF7F3;
      opacity: 0.6;
      text-align: center;
    }

    /* MAIN CONTENT AREA */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* HEADER */
    .header {
      height: var(--header-height);
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-titles {
      line-height: 1.2;
    }

    .header-title {
      font-size: 17px;
      font-weight: 700;
      color: #2E2C3E;
    }

    .header-subtitle {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-btn {
      padding: 6px 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      color: #666;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .header-btn .btn-icon {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .header-btn:hover {
      background: #f5f5f5;
      border-color: #FF4B7D;
      color: #FF4B7D;
    }

    .quit-btn {
      background: #FF4B7D;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .quit-btn:hover {
      background: #E63B6D;
    }

    .quit-btn .btn-icon {
      width: 14px;
      height: 14px;
    }

    /* CONTENT PANELS */
    .content-area {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .view-panel {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .view-panel.active {
      display: flex;
      flex-direction: column;
    }

    /* HOME VIEW - Always visible */
    #viewHome {
      display: flex !important;
      flex-direction: column;
    }

    /* DRAWER SYSTEM */
    .drawer-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 50;
    }

    .drawer-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .drawer-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 50%;
      min-width: 400px;
      max-width: 600px;
      height: 100%;
      background: white;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 51;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .drawer-panel.open {
      transform: translateX(0);
    }

    .drawer-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f8f8f8;
      flex-shrink: 0;
    }

    .drawer-title {
      font-size: 14px;
      font-weight: 700;
      color: #2E2C3E;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .drawer-title svg {
      width: 18px;
      height: 18px;
      fill: #FF4B7D;
    }

    .drawer-close {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: all 0.2s;
    }

    .drawer-close:hover {
      background: #f0f0f0;
      color: #FF4B7D;
    }

    .drawer-close svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    .drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }

    /* ACTION FOOTER */
    .action-footer {
      height: var(--footer-height);
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
      gap: 10px;
      flex-shrink: 0;
    }

    .btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      color: #666;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover:not(:disabled) {
      background: #f5f5f5;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #FF4B7D 0%, #FF6B9D 100%);
      color: white;
      border: none;
      padding: 10px 28px;
      font-size: 13px;
      font-weight: 600;
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #E63B6D 0%, #FF4B7D 100%);
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      border: none;
    }

    .btn-icon {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    /* ==========================================
       HOME VIEW
       ========================================== */

    .home-layout {
      display: flex;
      flex: 1;
      gap: 0;
      min-height: 0;
    }

    .home-left {
      width: var(--left-panel-width);
      min-width: 380px;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-right: 8px;
      overflow-y: auto;
    }

    .home-right {
      flex: 1;
      min-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-left: 8px;
      overflow-y: auto;
    }

    .resize-handle {
      width: 8px;
      cursor: col-resize;
      background: transparent;
      position: relative;
      flex-shrink: 0;
      min-height: 100%;
      z-index: 10;
    }

    .resize-handle::before {
      content: '';
      position: absolute;
      width: 2px;
      height: 100%;
      background: #e0e0e0;
      left: 50%;
      transform: translateX(-50%);
      transition: all 0.2s ease;
    }

    .resize-handle:hover::before {
      background: #FF4B7D;
      width: 3px;
    }

    .panel {
      background: white;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      padding: 16px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .panel-title {
      font-size: 12px;
      font-weight: 700;
      color: #FF4B7D;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Search Type + Output Combined */
    .search-output-grid {
      display: flex;
      gap: 12px;
    }

    .search-type-section {
      flex: 1;
    }

    .search-output-divider {
      width: 1px;
      background: #e0e0e0;
      margin: 0 4px;
    }

    .output-section {
      width: 210px;
      flex-shrink: 0;
    }

    .output-header {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 600;
      color: #666;
      margin-bottom: 6px;
    }

    .output-mode-btns {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
    }

    .output-mode-btn-sm {
      flex: 1;
      padding: 6px 6px;
      font-size: 10px;
      font-weight: 600;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .output-mode-btn-sm svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }

    .output-mode-btn-sm:hover {
      border-color: #FF4B7D;
    }

    .output-mode-btn-sm.active {
      background: #FF4B7D;
      color: white;
      border-color: #FF4B7D;
    }

    .filename-prefix-row {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .filename-prefix-row label {
      font-size: 9px;
      color: #666;
    }

    .filename-prefix-row input {
      padding: 5px 8px;
      font-size: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
    }

    /* Search Type */
    .search-type-grid {
      display: block;
    }

    .search-type-dropdown {
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 600;
      color: #2E2C3E;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      background: white;
      cursor: pointer;
    }

    .search-type-dropdown:hover,
    .search-type-dropdown:focus {
      border-color: #FF4B7D;
      outline: none;
    }

    .search-type-description {
      font-size: 11px;
      color: #666;
      line-height: 1.5;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
      margin-top: 10px;
    }

    .phone-input-container {
      display: none;
    }

    .phone-input-container.visible {
      display: block;
    }

    .phone-input-container textarea:focus {
      border-color: #FF4B7D;
      outline: none;
    }

    .trend-analyzer-container {
      display: none;
    }

    .trend-analyzer-container.visible {
      display: block;
    }

    .trend-analyzer-subtitle {
      font-size: 10px;
      color: #666;
      padding: 0 12px 8px;
      border-bottom: 1px solid #eee;
      margin-bottom: 8px;
    }

    .trend-analyzer-content {
      padding: 2px;
    }

    .trend-analyzer-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .trend-thresholds, .trend-generate {
      padding: 10px;
      background: #fafafa;
      border-radius: 6px;
    }

    .trend-section-title {
      font-size: 10px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .clear-selection-link {
      font-size: 9px;
      font-weight: 400;
      color: #888;
      text-decoration: none;
      cursor: pointer;
    }

    .clear-selection-link:hover {
      color: #FF4B7D;
      text-decoration: underline;
    }

    .threshold-field {
      margin-bottom: 8px;
    }

    .threshold-field:last-child {
      margin-bottom: 0;
    }

    .threshold-field label {
      display: block;
      font-size: 9px;
      color: #666;
      margin-bottom: 3px;
    }

    .threshold-field input {
      width: 100%;
      padding: 6px 8px;
      font-size: 11px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .trend-radio-option {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 0;
      cursor: pointer;
      font-size: 11px;
    }

    .trend-radio-option input[type="radio"] {
      margin: 0;
    }

    .trend-action-area {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e0e0e0;
    }

    .trend-action-btn {
      font-size: 10px;
      padding: 6px 10px;
      width: 100%;
    }

    .uploaded-filename {
      display: block;
      font-size: 9px;
      color: #666;
      margin: 4px 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Date Range */
    .date-range-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .date-range-preset-row {
      width: 100%;
    }

    .date-range-dates-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .date-range-grid select,
    .date-range-grid input {
      width: 100%;
      padding: 8px 10px;
      font-size: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .date-range-grid label {
      display: block;
      font-size: 10px;
      font-weight: 500;
      color: #666;
      margin-bottom: 4px;
    }

    /* Status Section */
    .status-panel {
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
    }

    .status-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
    }

    .status-title {
      font-size: 13px;
      font-weight: 600;
    }

    .status-actions {
      display: flex;
      gap: 6px;
    }

    .btn-status {
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn-status:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-status-green {
      background: var(--success);
      color: white;
    }

    .btn-status-green:hover:not(:disabled) {
      background: var(--success-hover);
    }

    .btn-status-amber {
      background: #f59e0b;
      color: white;
    }

    .btn-status-amber:hover:not(:disabled) {
      background: #d97706;
    }

    .btn-status svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }

    .artifact-row {
      font-size: 10px;
      color: #666;
      margin-top: 5px;
      display: flex;
      gap: 5px;
    }

    .artifact-row code {
      font-family: "SF Mono", Monaco, monospace;
      background: #e5e7eb;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 9px;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Progress Bar */
    .progress-panel {
      display: none;
      padding: 10px;
      background: #fff7ed;
      border: 1px solid #fed7aa;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .progress-panel.visible {
      display: block;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .progress-percent {
      color: #FF4B7D;
      font-size: 12px;
    }

    .progress-bar-container {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #FF4B7D 0%, #FF6B9D 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-bar.indeterminate {
      background: linear-gradient(90deg, #FF4B7D 0%, #FF6B9D 50%, #FF4B7D 100%);
      background-size: 200% 100%;
      animation: indeterminate 1.5s ease-in-out infinite;
    }

    @keyframes indeterminate {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Live Log */
    .log-panel {
      flex: 1;
      min-height: 250px;
      display: flex;
      flex-direction: column;
    }

    .log-container {
      flex: 1;
      background: #1a1a1a;
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .log-header {
      padding: 10px 12px;
      background: #2a2a2a;
      border-bottom: 1px solid #3a3a3a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .log-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .log-title {
      font-size: 12px;
      font-weight: 600;
      color: #fff;
    }

    .log-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .log-actions .btn {
      padding: 4px 8px;
      font-size: 10px;
      background: #1a1a1a;
      color: #e0e0e0;
      border: 1px solid #3a3a3a;
    }

    .log-actions .btn:hover {
      background: #333;
      border-color: #FF4B7D;
    }

    .log-filter-row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      max-width: 280px;
    }

    .log-filter-input {
      flex: 1;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px 8px;
      color: #fff;
      font-size: 10px;
      outline: none;
      min-width: 80px;
    }

    .log-filter-input:focus {
      border-color: #FF4B7D;
    }

    .log-filter-nav {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .log-filter-nav button {
      background: #333;
      border: 1px solid #444;
      color: #ccc;
      padding: 3px 6px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
    }

    .log-filter-nav button:hover {
      background: #444;
      color: #FF4B7D;
    }

    .log-filter-count {
      font-size: 10px;
      color: #888;
      white-space: nowrap;
      min-width: 50px;
    }

    .log-content {
      padding: 10px;
      font-family: "SF Mono", Monaco, monospace;
      font-size: 10px;
      color: #e0e0e0;
      overflow-y: auto;
      flex: 1;
    }

    .log-entry {
      white-space: pre-wrap;
      word-break: break-word;
      padding: 1px 0;
      line-height: 1.4;
    }

    .log-entry.filtered {
      display: none;
    }

    .log-entry mark {
      background: #FF4B7D;
      color: white;
      padding: 0 2px;
      border-radius: 2px;
    }

    .log-entry.current-match {
      background: rgba(255, 75, 125, 0.2);
      border-radius: 2px;
    }

    /* ==========================================
       OUTPUT MODE VIEW
       ========================================== */

    .settings-panel {
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }

    .settings-section {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    .settings-section-title {
      font-size: 14px;
      font-weight: 700;
      color: #2E2C3E;
      margin-bottom: 2px;
    }

    .settings-section-subtitle {
      font-size: 11px;
      color: #888;
      margin-bottom: 16px;
    }

    /* Output Mode Layout - vertical buttons + database side by side */
    .output-mode-layout {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .output-mode-buttons-vertical {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex-shrink: 0;
    }

    .output-mode-btn {
      padding: 10px 14px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .output-mode-btn:hover {
      border-color: #FF4B7D;
    }

    .output-mode-btn.active {
      background: linear-gradient(135deg, #FF4B7D 0%, #FF6B9D 100%);
      color: white;
      border-color: transparent;
    }

    .output-mode-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    /* Database Panel */
    .database-panel-wrapper {
      flex: 1;
      position: relative;
    }

    .database-panel {
      padding: 14px;
      border: 2px solid #0EA5E9;
      border-radius: 8px;
      background: #f0f9ff;
    }

    .database-panel.inactive {
      border-color: #d1d5db;
      background: #f3f4f6;
    }

    .database-panel.inactive .database-panel-title {
      color: #6b7280;
    }

    .database-panel.inactive .database-status-badge {
      background: #e5e7eb;
      color: #6b7280;
    }

    .database-panel.inactive .database-stats-value {
      color: #9ca3af;
    }

    .database-overlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(156, 163, 175, 0.4);
      border-radius: 8px;
      z-index: 10;
    }

    .database-panel-wrapper.inactive .database-overlay {
      display: block;
    }

    .database-panel-title {
      font-size: 12px;
      font-weight: 600;
      color: #0EA5E9;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .database-status-badge {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .database-status-ready {
      background: #dcfce7;
      color: #166534;
    }

    .database-status-inactive {
      background: #e5e7eb;
      color: #6b7280;
    }

    .database-status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .database-stats {
      background: white;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 12px;
    }

    .database-stats-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 11px;
      border-bottom: 1px solid #f0f0f0;
    }

    .database-stats-row:last-child {
      border-bottom: none;
    }

    .database-stats-label {
      color: #666;
    }

    .database-stats-value {
      font-weight: 600;
      color: #0EA5E9;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 10px;
    }

    .database-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }

    .database-btn {
      padding: 7px 10px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 5px;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .database-btn svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }

    .database-btn:hover {
      background: #f5f5f5;
    }

    .database-btn.danger:hover {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #dc2626;
    }

    /* SQL Query Section */
    .query-section {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
    }

    .query-section-title {
      font-size: 10px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .query-textarea {
      width: 100%;
      min-height: 60px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 10px;
      resize: vertical;
    }

    .query-textarea:focus {
      border-color: #0EA5E9;
      outline: none;
    }

    .query-results {
      margin-top: 10px;
      max-height: 150px;
      overflow: auto;
      background: #1e1e1e;
      border-radius: 5px;
      padding: 10px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 9px;
      color: #d4d4d4;
      display: none;
    }

    .query-results.show {
      display: block;
    }

    /* ==========================================
       ACCOUNTS VIEW
       ========================================== */

    .accounts-input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }

    .accounts-input-row input {
      flex: 1;
      padding: 8px 10px;
      font-size: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .accounts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid #e5e5e5;
      border-radius: 6px 6px 0 0;
      font-size: 12px;
      font-weight: 600;
    }

    .accounts-header-actions {
      display: flex;
      gap: 10px;
      font-size: 11px;
    }

    .accounts-header-actions a {
      color: #FF4B7D;
      text-decoration: none;
      cursor: pointer;
    }

    .accounts-header-actions a:hover {
      text-decoration: underline;
    }

    .accounts-list-wrapper {
      display: flex;
      border: 1px solid #e5e5e5;
      border-top: none;
      border-radius: 0 0 6px 6px;
      max-height: 280px;
      overflow: hidden;
    }

    .accounts-column {
      flex: 1;
      overflow-y: auto;
      padding: 6px 10px;
    }

    .accounts-resize-handle {
      width: 10px;
      cursor: col-resize;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }

    .accounts-resize-handle:hover {
      background: #FF4B7D;
    }

    .accounts-resize-handle::before {
      content: 'â‹®';
      color: #999;
      font-size: 14px;
    }

    .accounts-resize-handle:hover::before {
      color: white;
    }

    .account-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      font-size: 11px;
      cursor: pointer;
      border-radius: 4px;
    }

    .account-item:hover {
      background: #f5f5f5;
    }

    .account-item input {
      width: auto;
      margin: 0;
    }

    /* ==========================================
       REPORT HEADERS VIEW
       ========================================== */

    .columns-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
    }

    .column-group {
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      padding: 12px;
    }

    .column-group-title {
      font-size: 11px;
      font-weight: 700;
      color: #FF4B7D;
      margin-bottom: 10px;
      text-transform: uppercase;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .col-group-actions {
      display: flex;
      gap: 6px;
      font-size: 9px;
      font-weight: 500;
      text-transform: none;
    }

    .col-group-actions span {
      cursor: pointer;
      color: #888;
      text-decoration: underline;
    }

    .col-group-actions span:hover {
      color: #FF4B7D;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 3px 0;
      cursor: pointer;
    }

    .checkbox-label input {
      width: auto;
    }

    /* ==========================================
       API KEY VIEW
       ========================================== */

    .api-key-input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .api-key-input-row input {
      flex: 1;
      padding: 10px 12px;
      font-size: 13px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .api-key-input-row input:focus {
      border-color: #FF4B7D;
      outline: none;
    }

    /* ==========================================
       MODALS
       ========================================== */

    .info-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .info-modal.visible {
      display: flex;
    }

    .info-modal-content {
      background: white;
      border-radius: 10px;
      padding: 20px;
      max-width: 550px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .info-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .info-modal-title {
      font-size: 15px;
      font-weight: 700;
      color: #FF4B7D;
    }

    .info-modal-close {
      background: #f0f0f0;
      border: none;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .info-modal-close:hover {
      background: #FF4B7D;
      color: white;
    }

    .info-modal-body {
      font-size: 12px;
      line-height: 1.6;
    }

    .info-modal-body h4 {
      font-size: 13px;
      font-weight: 600;
      color: #FF4B7D;
      margin-top: 14px;
      margin-bottom: 6px;
    }

    .info-modal-body h4:first-child {
      margin-top: 0;
    }

    .info-modal-body ul, .info-modal-body ol {
      margin-left: 18px;
      margin-bottom: 10px;
    }

    .info-modal-body code {
      background: #f5f5f5;
      padding: 2px 5px;
      border-radius: 3px;
      font-family: "SF Mono", Monaco, monospace;
      font-size: 11px;
      color: #FF4B7D;
    }

    /* ==========================================
       TOAST NOTIFICATIONS
       ========================================== */

    .toast-container {
      position: fixed;
      bottom: 70px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 350px;
    }

    .toast {
      background: white;
      border-radius: 6px;
      padding: 10px 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideInRight 0.3s ease;
      border-left: 4px solid;
    }

    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: #dc2626; }
    .toast.info { border-left-color: #3b82f6; }

    .toast-icon { font-size: 16px; }
    .toast-message { flex: 1; font-size: 12px; }
    .toast-close { cursor: pointer; opacity: 0.5; font-size: 14px; }
    .toast-close:hover { opacity: 1; }

    @keyframes slideInRight {
      from { transform: translateX(350px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* INFO ICONS */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: transparent;
      border: 1px solid #ccc;
      color: #888;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 5px;
      transition: all 0.2s ease;
    }

    .info-icon:hover {
      background: #f0f0f0;
      border-color: #FF4B7D;
      color: #FF4B7D;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- LEFT SIDEBAR -->
    <nav class="sidebar">
      <div class="sidebar-logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400" aria-hidden="true">
          <circle cx="48.53" cy="63.95" r="50" fill="#FBF7F3"/>
          <circle cx="199.50" cy="63.96" r="50" fill="#FBF7F3"/>
          <circle cx="350.46" cy="63.93" r="50" fill="#FBF7F3"/>
          <circle cx="199.50" cy="199.58" r="50" fill="#FBF7F3"/>
          <circle cx="350.48" cy="199.60" r="50" fill="#FBF7F3"/>
          <circle cx="350.47" cy="335.06" r="50" fill="#FBF7F3"/>
        </svg>
      </div>

      <div class="sidebar-nav">
        <div class="sidebar-item active" data-view="home" onclick="closeDrawer()">
          <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
          <span class="sidebar-item-tooltip">Home</span>
        </div>
        <div class="sidebar-item" data-view="accounts" onclick="toggleDrawer('accounts')">
          <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
          <span class="sidebar-item-tooltip">Accounts</span>
        </div>
        <div class="sidebar-item" data-view="output" onclick="toggleDrawer('output')">
          <svg viewBox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7v10c0 2.21 3.58 4 8 4s8-1.79 8-4V7c0-2.21-3.58-4-8-4zm0 2c3.87 0 6 1.5 6 2s-2.13 2-6 2-6-1.5-6-2 2.13-2 6-2zm6 12c0 .5-2.13 2-6 2s-6-1.5-6-2v-2.23c1.61.78 3.72 1.23 6 1.23s4.39-.45 6-1.23V17zm0-4c0 .5-2.13 2-6 2s-6-1.5-6-2v-2.23c1.61.78 3.72 1.23 6 1.23s4.39-.45 6-1.23V13z"/></svg>
          <span class="sidebar-item-tooltip">Database</span>
        </div>
        <div class="sidebar-item" data-view="report" onclick="toggleDrawer('report')">
          <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
          <span class="sidebar-item-tooltip">Report Headers</span>
        </div>
        <div class="sidebar-item" data-view="api" onclick="toggleDrawer('api')">
          <svg viewBox="0 0 24 24"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
          <span class="sidebar-item-tooltip">API Key</span>
        </div>
      </div>

      <div class="sidebar-footer">
        <div class="sidebar-version">v3.2.0</div>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <!-- HEADER -->
      <header class="header">
        <div class="header-left">
          <div class="header-titles">
            <div class="header-title">VoApps Tools</div>
            <div class="header-subtitle">DirectDrop Voicemail Analytics</div>
          </div>
        </div>
        <div class="header-right">
          <button class="header-btn" onclick="checkForUpdates()">
            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79s7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.53-9.11-.02-12.58s9.14-3.47 12.65 0L21 3v7.12zM12.5 8v4.25l3.5 2.08-.72 1.21L11 13V8h1.5z"/></svg>
            Updates
          </button>
          <button class="header-btn" onclick="toggleHelp()">
            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
            Help
          </button>
          <button id="quitBtn" class="quit-btn">
            <svg class="btn-icon" style="fill:white;" viewBox="0 0 24 24"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
            Quit
          </button>
        </div>
      </header>

      <!-- CONTENT AREA -->
      <div class="content-area">
        <!-- HOME VIEW -->
        <div id="viewHome" class="view-panel active">
          <div class="home-layout">
            <!-- LEFT COLUMN -->
            <div class="home-left" id="homeLeft">
              <!-- SEARCH TYPE + OUTPUT combined panel -->
              <div class="panel">
                <div class="panel-header">
                  <div class="panel-title">
                    <svg style="width: 14px; height: 14px; fill: currentColor; margin-right: 4px;" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    Search Type
                  </div>
                  <span class="info-icon" onclick="showInfoModal('searchType')">i</span>
                </div>
                <div class="search-output-grid">
                  <div class="search-type-section">
                    <select id="searchTypeDropdown" class="search-type-dropdown">
                      <option value="phone">Phone Number(s)</option>
                      <option value="combine">Combine Campaigns</option>
                      <option value="bulk-export">Bulk Campaign Export</option>
                    </select>
                    <div id="searchTypeDescription" class="search-type-description">
                      Searches all campaigns for the specified phone numbers and returns detailed interaction history.
                    </div>
                  </div>
                  <div class="search-output-divider"></div>
                  <div class="output-section">
                    <div class="output-header">
                      <svg style="width: 12px; height: 12px; fill: currentColor;" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                      <span>Output</span>
                    </div>
                    <div class="output-mode-btns">
                      <button id="outputModeCSV" class="output-mode-btn-sm active" onclick="setOutputMode('csv')">
                        <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                        CSV
                      </button>
                      <button id="outputModeDatabase" class="output-mode-btn-sm" onclick="setOutputMode('database')">
                        <svg viewBox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7v10c0 2.21 3.58 4 8 4s8-1.79 8-4V7c0-2.21-3.58-4-8-4zm0 2c3.87 0 6 1.5 6 2s-2.13 2-6 2-6-1.5-6-2 2.13-2 6-2z"/></svg>
                        Database
                      </button>
                      <button id="outputModeBoth" class="output-mode-btn-sm" onclick="setOutputMode('both')">
                        <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/></svg>
                        Both
                      </button>
                    </div>
                    <div class="filename-prefix-row">
                      <label>Filename Prefix</label>
                      <input type="text" id="clientPrefix" placeholder="e.g., ClientName" />
                    </div>
                  </div>
                </div>
              </div>

              <!-- PHONE INPUT (for phone search) -->
              <div id="phoneInputContainer" class="panel phone-input-container visible">
                <div class="panel-header">
                  <div class="panel-title">
                    <svg style="width: 14px; height: 14px; fill: currentColor; margin-right: 4px;" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
                    Phone Numbers
                  </div>
                </div>
                <textarea id="phoneNumbers" placeholder="Enter phone numbers (one per line or comma-separated)" style="width: 100%; min-height: 80px; padding: 10px; font-size: 12px; border: 2px solid #e0e0e0; border-radius: 6px; resize: vertical; font-family: inherit; box-sizing: border-box;"></textarea>
              </div>

              <!-- NUMBER TREND ANALYZER -->
              <div id="trendAnalyzerContainer" class="panel trend-analyzer-container">
                <div class="panel-header">
                  <div class="panel-title">
                    <svg style="width: 14px; height: 14px; fill: currentColor; margin-right: 4px;" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                    Number Trend Analyzer
                  </div>
                  <span class="info-icon" onclick="showInfoModal('trendAnalyzer')">i</span>
                </div>
                <div class="trend-analyzer-subtitle">Creates Excel analysis with success rates, patterns, and insights</div>
                <div class="trend-analyzer-content">
                  <div class="trend-analyzer-layout">
                    <!-- Left: Thresholds -->
                    <div class="trend-thresholds">
                      <div class="trend-section-title">Consecutive Unsuccessful</div>
                      <div class="threshold-field">
                        <label>Min Count</label>
                        <input type="number" id="minConsecUnsuccessful" min="2" max="20" value="4">
                      </div>
                      <div class="threshold-field">
                        <label>Min Days</label>
                        <input type="number" id="minRunSpanDays" min="1" max="365" value="30">
                      </div>
                    </div>
                    <!-- Right: Generate Options -->
                    <div class="trend-generate">
                      <div class="trend-section-title">
                        Generate Analysis
                        <a href="#" id="clearTrendSelection" class="clear-selection-link" style="display: none;" onclick="event.preventDefault(); clearTrendSelection();">clear</a>
                      </div>
                      <label class="trend-radio-option">
                        <input type="radio" name="trendSource" value="combine" id="trendSourceCombine">
                        <span>...with Combine Campaigns</span>
                      </label>
                      <label class="trend-radio-option">
                        <input type="radio" name="trendSource" value="csv" id="trendSourceCsv">
                        <span>...from CSV</span>
                      </label>
                      <label class="trend-radio-option">
                        <input type="radio" name="trendSource" value="database" id="trendSourceDb">
                        <span>...from Database</span>
                      </label>
                      <!-- Dynamic action buttons -->
                      <div id="trendActionArea" class="trend-action-area">
                        <input type="file" id="csvFileUpload" accept=".csv" style="display: none;">
                        <button id="uploadCsvBtn" class="btn trend-action-btn" style="display: none;">
                          <svg class="btn-icon" viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                          Upload CSV
                        </button>
                        <span id="uploadedFileName" class="uploaded-filename" style="display: none;"></span>
                        <button id="runAnalyzerBtn" class="btn btn-primary trend-action-btn" style="display: none;">
                          <svg class="btn-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                          Run Analysis
                        </button>
                        <button id="runDbAnalysisBtn" class="btn trend-action-btn" style="display: none;">
                          <svg class="btn-icon" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                          Analyze Database
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- DATE RANGE -->
              <div class="panel">
                <div class="panel-header">
                  <div class="panel-title">
                    <svg style="width: 14px; height: 14px; fill: currentColor; margin-right: 4px;" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>
                    Date Range
                  </div>
                  <span class="info-icon" onclick="showInfoModal('dateRange')">i</span>
                </div>
                <div class="date-range-grid">
                  <div class="date-range-preset-row">
                    <label>Preset</label>
                    <select id="datePreset" style="width: 100%;">
                      <option value="">Custom...</option>
                      <option value="months_1">1 Month</option>
                      <option value="months_2">2 Months</option>
                      <option value="months_3">3 Months</option>
                      <option value="months_6">6 Months</option>
                      <option value="years_1">1 Year</option>
                      <option value="years_2">2 Years</option>
                      <option value="years_3">3 Years</option>
                      <option value="years_4">4 Years</option>
                      <option value="years_5">5 Years</option>
                    </select>
                  </div>
                  <div class="date-range-dates-row">
                    <div>
                      <label>Start</label>
                      <input id="startDate" type="date" />
                    </div>
                    <div>
                      <label>End</label>
                      <input id="endDate" type="date" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- RESIZE HANDLE -->
            <div class="resize-handle" id="homeResizeHandle"></div>

            <!-- RIGHT COLUMN -->
            <div class="home-right" id="homeRight">
              <!-- STATUS -->
              <div class="panel">
                <div class="panel-header">
                  <div class="panel-title">
                    <svg style="width: 14px; height: 14px; fill: currentColor; margin-right: 4px;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    Status
                  </div>
                </div>
                <div id="progressPanel" class="progress-panel">
                  <div class="progress-header">
                    <span id="progressText">Processing...</span>
                    <span id="progressPercent" class="progress-percent">0%</span>
                  </div>
                  <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar"></div>
                  </div>
                </div>
                <div class="status-panel">
                  <div class="status-header">
                    <div class="status-indicator">
                      <div id="statusDot" class="status-dot"></div>
                      <span id="statusTitle" class="status-title">Ready</span>
                    </div>
                    <div class="status-actions">
                      <button id="openCsvBtn" class="btn-status btn-status-green" disabled>
                        <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        CSV
                      </button>
                      <button id="openLogBtn" class="btn-status btn-status-amber" disabled>
                        <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                        Log
                      </button>
                      <button id="openAnalysisBtn" class="btn-status btn-status-green" disabled style="display:none;">
                        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                        Analysis
                      </button>
                    </div>
                  </div>
                  <div class="artifact-row">
                    <strong>CSV:</strong>
                    <code id="csvPath">â€”</code>
                  </div>
                  <div class="artifact-row" id="analysisPathRow" style="display:none;">
                    <strong>Analysis:</strong>
                    <code id="analysisPath">â€”</code>
                  </div>
                  <div class="artifact-row">
                    <strong>Log:</strong>
                    <code id="logPath">â€”</code>
                  </div>
                </div>
              </div>

              <!-- LIVE LOG -->
              <div class="panel log-panel">
                <div class="panel-header">
                  <div class="panel-title">
                    <svg style="width: 14px; height: 14px; fill: currentColor; margin-right: 4px;" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-6 10H6v-2h8v2zm4-4H6v-2h12v2z"/></svg>
                    Live Log
                  </div>
                </div>
                <div class="log-container">
                  <div class="log-header">
                    <div class="log-header-left">
                      <span class="log-title">Output</span>
                      <select id="logLevel" style="padding: 3px 6px; font-size: 10px; background: #1a1a1a; color: #e0e0e0; border: 1px solid #3a3a3a; border-radius: 3px;">
                        <option value="none">None</option>
                        <option value="minimal">Minimal</option>
                        <option value="normal" selected>Normal</option>
                        <option value="verbose">Verbose</option>
                      </select>
                    </div>
                    <div class="log-filter-row">
                      <input id="logFilterInput" class="log-filter-input" placeholder="Filter..." autocomplete="off" />
                      <div class="log-filter-nav">
                        <button id="logFilterPrev" title="Previous">â–²</button>
                        <button id="logFilterNext" title="Next">â–¼</button>
                      </div>
                      <span id="logFilterCount" class="log-filter-count"></span>
                    </div>
                    <div class="log-actions">
                      <button id="openErrorsBtn" class="btn" disabled>Errors</button>
                      <button id="clearLogBtn" class="btn">Clear</button>
                    </div>
                  </div>
                  <div id="logContent" class="log-content"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- DRAWER OVERLAY -->
        <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

        <!-- DATABASE DRAWER -->
        <div id="drawerOutput" class="drawer-panel">
          <div class="drawer-header">
            <div class="drawer-title">
              <svg viewBox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7v10c0 2.21 3.58 4 8 4s8-1.79 8-4V7c0-2.21-3.58-4-8-4zm0 2c3.87 0 6 1.5 6 2s-2.13 2-6 2-6-1.5-6-2 2.13-2 6-2zm6 12c0 .5-2.13 2-6 2s-6-1.5-6-2v-2.23c1.61.78 3.72 1.23 6 1.23s4.39-.45 6-1.23V17zm0-4c0 .5-2.13 2-6 2s-6-1.5-6-2v-2.23c1.61.78 3.72 1.23 6 1.23s4.39-.45 6-1.23V13z"/></svg>
              Database
              <span class="info-icon info-icon-drawer" onclick="event.stopPropagation(); showInfoModal('database')">i</span>
            </div>
            <button class="drawer-close" onclick="closeDrawer()">
              <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
          </div>
          <div class="drawer-content">
            <div class="settings-section">
              <div class="settings-section-subtitle">Local DuckDB database for campaign data</div>

              <div class="database-stats">
                <div class="database-stats-row">
                  <span class="database-stats-label">Total Records</span>
                  <span class="database-stats-value" id="dbTotalRows">0</span>
                </div>
                <div class="database-stats-row">
                  <span class="database-stats-label">Unique Numbers</span>
                  <span class="database-stats-value" id="dbUniqueNumbers">0</span>
                </div>
                <div class="database-stats-row">
                  <span class="database-stats-label">Campaigns</span>
                  <span class="database-stats-value" id="dbUniqueCampaigns">0</span>
                </div>
                <div class="database-stats-row">
                  <span class="database-stats-label">Date Range</span>
                  <span class="database-stats-value" id="dbDateRange">â€”</span>
                </div>
                <div class="database-stats-row">
                  <span class="database-stats-label">Size</span>
                  <span class="database-stats-value" id="dbSize">0 MB</span>
                </div>
              </div>

              <div class="database-actions">
                <button class="database-btn" onclick="refreshDatabaseStats()">
                  <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                  Refresh
                </button>
                <button class="database-btn" onclick="exportDatabase()">
                  <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                  Export
                </button>
                <button class="database-btn" onclick="compactDatabase()">
                  <svg viewBox="0 0 24 24"><path d="M8 11h3v10h2V11h3l-4-4-4 4zM4 3v2h16V3H4z"/></svg>
                  Compact
                </button>
                <button class="database-btn danger" onclick="clearDatabase()">
                  <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                  Clear
                </button>
              </div>

              <!-- Run Trend Analyzer from Database -->
              <div class="settings-section" style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                <div style="font-size: 11px; font-weight: 600; color: #333; margin-bottom: 8px;">
                  <svg style="width: 14px; height: 14px; fill: #666; vertical-align: middle; margin-right: 4px;" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
                  Number Trend Analyzer
                </div>
                <div style="font-size: 10px; color: #666; margin-bottom: 10px;">
                  Analyze patterns in database records. Uses current date range selection.
                </div>
                <button class="database-btn" onclick="runDbTrendAnalysis()" style="width: 100%;">
                  <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                  Run Analysis
                </button>
              </div>

              <div class="query-section">
                <div class="query-section-title">SQL Query</div>
                <div style="display: flex; gap: 6px; margin-bottom: 6px;">
                  <select id="sampleQueries" onchange="loadSampleQuery(this.value)" style="flex: 1; padding: 6px; font-size: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Sample Queries --</option>
                    <option value="recent">Recent 100</option>
                    <option value="by-account">By Account</option>
                    <option value="success-rate">Success Rate</option>
                    <option value="duplicates">Duplicates</option>
                  </select>
                  <button onclick="saveCurrentQuery()" class="database-btn" style="padding: 6px 10px;">Save</button>
                </div>
                <textarea id="sqlQuery" class="query-textarea" placeholder="SELECT * FROM campaign_results LIMIT 10"></textarea>
                <div style="display: flex; gap: 6px; margin-top: 6px;">
                  <button class="database-btn" onclick="runQuery()" style="flex: 1;">Run</button>
                  <button id="copyQueryBtn" class="database-btn" onclick="copyQueryResults()" style="display: none;">Copy</button>
                </div>
                <div id="queryResults" class="query-results">
                  <pre id="queryResultsContent"></pre>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- REPORT HEADERS DRAWER -->
        <div id="drawerReport" class="drawer-panel">
          <div class="drawer-header">
            <div class="drawer-title">
              <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
              Report Headers
              <span class="info-icon info-icon-drawer" onclick="event.stopPropagation(); showInfoModal('reportHeaders')">i</span>
            </div>
            <button class="drawer-close" onclick="closeDrawer()">
              <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
          </div>
          <div class="drawer-content">
            <div class="settings-section">
              <div class="settings-section-subtitle">Select columns to include in CSV exports</div>

              <div class="columns-grid">
                <div class="column-group">
                  <div class="column-group-title">
                    Core
                    <div class="col-group-actions">
                      <span onclick="toggleGroup('core', true)">all</span>
                      <span onclick="toggleGroup('core', false)">clear</span>
                    </div>
                  </div>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-core" value="number" checked> number</label>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-core" value="account_id" checked> account_id</label>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-core" value="campaign_id" checked> campaign_id</label>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-core" value="campaign_name" checked> campaign_name</label>
                </div>

                <div class="column-group">
                  <div class="column-group-title">
                    Metadata
                    <div class="col-group-actions">
                      <span onclick="toggleGroup('optional', true)">all</span>
                      <span onclick="toggleGroup('optional', false)">clear</span>
                    </div>
                  </div>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-optional" value="caller_number" checked> caller_number</label>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-optional" value="caller_number_name" checked> caller_number_name</label>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-optional" value="message_id" checked> message_id</label>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-optional" value="message_name" checked> message_name</label>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-optional" value="message_description" checked> message_description</label>
                </div>

                <div class="column-group">
                  <div class="column-group-title">
                    Results
                    <div class="col-group-actions">
                      <span onclick="toggleGroup('results', true)">all</span>
                      <span onclick="toggleGroup('results', false)">clear</span>
                    </div>
                  </div>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-results" value="voapps_result" checked> voapps_result</label>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-results" value="voapps_code" checked> voapps_code</label>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-results" value="voapps_timestamp" checked> voapps_timestamp</label>
                  <label class="checkbox-label"><input type="checkbox" class="col-check col-results" value="campaign_url" checked> campaign_url</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- API KEY DRAWER -->
        <div id="drawerApi" class="drawer-panel">
          <div class="drawer-header">
            <div class="drawer-title">
              <svg viewBox="0 0 24 24"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
              API Key
              <span class="info-icon info-icon-drawer" onclick="event.stopPropagation(); showInfoModal('apiKey')">i</span>
            </div>
            <button class="drawer-close" onclick="closeDrawer()">
              <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
          </div>
          <div class="drawer-content">
            <div class="settings-section">
              <div class="settings-section-subtitle">Your VoApps API key is stored locally</div>

              <div class="api-key-input-row">
                <input id="apiKey" type="password" placeholder="Paste your VoApps API key..." />
                <button id="toggleApiKeyVisibility" class="btn" title="Show/Hide">
                  <svg class="btn-icon" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                </button>
              </div>
              <div style="display: flex; gap: 8px;">
                <button id="saveKeyBtn" class="btn">
                  <svg class="btn-icon" viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                  Save
                </button>
                <button id="clearKeyBtn" class="btn">
                  <svg class="btn-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                  Clear
                </button>
                <button id="pingBtn" class="btn" style="margin-left: auto;">
                  <svg class="btn-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                  Test
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ACCOUNTS DRAWER -->
        <div id="drawerAccounts" class="drawer-panel">
          <div class="drawer-header">
            <div class="drawer-title">
              <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
              Accounts
              <span class="info-icon info-icon-drawer" onclick="event.stopPropagation(); showInfoModal('accounts')">i</span>
            </div>
            <button class="drawer-close" onclick="closeDrawer()">
              <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
          </div>
          <div class="drawer-content">
            <div class="settings-section">
              <div class="settings-section-subtitle">Load and select accounts to search</div>

              <div class="accounts-input-row">
                <button id="loadAccountsBtn" class="btn">
                  <svg class="btn-icon" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                  Load
                </button>
                <input id="manualAccountIds" type="text" placeholder="Or enter account IDs (comma-separated)" />
              </div>

              <div id="accountsContainer" style="display: none;">
                <div id="accountsHeader" class="accounts-header">
                  <span>Select accounts: <span id="accountCount">0</span></span>
                  <div class="accounts-header-actions">
                    <a onclick="selectAllAccounts()">all</a>
                    <a onclick="selectActiveAccounts()">active</a>
                    <a onclick="clearAccounts()">clear</a>
                  </div>
                </div>
                <div id="accountsList" class="accounts-list-wrapper">
                  <div class="accounts-column" id="accountsColumnLeft"></div>
                  <div class="accounts-resize-handle" id="accountsResizeHandle"></div>
                  <div class="accounts-column" id="accountsColumnRight"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ACTION FOOTER -->
      <footer class="action-footer">
        <button id="runBtn" class="btn btn-primary">
          <svg class="btn-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          Run
        </button>
        <button id="pauseBtn" class="btn" disabled>
          <svg class="btn-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
          Pause
        </button>
        <button id="cancelBtn" class="btn btn-danger" style="display: none;">
          <svg class="btn-icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          Cancel
        </button>
      </footer>
    </div>
  </div>

  <!-- MODALS -->
  <div id="dateRangeModal" class="info-modal" onclick="if(event.target === this) hideInfoModal('dateRange')">
    <div class="info-modal-content">
      <div class="info-modal-header">
        <div class="info-modal-title">ðŸ“… Date Range</div>
        <button class="info-modal-close" onclick="hideInfoModal('dateRange')">Ã—</button>
      </div>
      <div class="info-modal-body" style="font-size: 12px;">
        <h4>How It Works</h4>
        <p>The date range filters campaigns by their <code>target_date</code> (the scheduled delivery date). The API searches by <code>created_date</code> with a 7-day buffer on each side to ensure all relevant campaigns are found.</p>

        <h4>âš ï¸ UTC Timezone Important</h4>
        <p>All dates in VoApps are stored in <strong>UTC (Coordinated Universal Time)</strong>. This means:</p>
        <ul style="margin-left: 16px; margin-bottom: 12px;">
          <li><strong>PST/PDT:</strong> UTC midnight = 4:00 PM / 5:00 PM previous day</li>
          <li><strong>EST/EDT:</strong> UTC midnight = 7:00 PM / 8:00 PM previous day</li>
          <li><strong>CST/CDT:</strong> UTC midnight = 6:00 PM / 7:00 PM previous day</li>
        </ul>
        <p>For example, if you select "2026-01-15" as your start date, you'll get campaigns starting from midnight UTC on January 15th, which is the evening of January 14th in US timezones.</p>

        <h4>Presets</h4>
        <p>Use the preset dropdown for quick date ranges. "1 Month" sets the start date to one month before today. The end date is always set to today.</p>

        <h4>Tips</h4>
        <ul style="margin-left: 16px;">
          <li>If you're missing expected data, try expanding your date range by a day or two</li>
          <li>Very large date ranges (2+ years) may take longer to process</li>
          <li>The VoApps API limits results to campaigns within your account's data retention period</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Search Type Info Modal -->
  <div id="searchTypeModal" class="info-modal" onclick="if(event.target === this) hideInfoModal('searchType')">
    <div class="info-modal-content">
      <div class="info-modal-header">
        <div class="info-modal-title">ðŸ” Search Types</div>
        <button class="info-modal-close" onclick="hideInfoModal('searchType')">Ã—</button>
      </div>
      <div class="info-modal-body" style="font-size: 12px;">
        <h4>Phone Number(s)</h4>
        <p>Search for specific phone numbers across all campaigns. Enter numbers one per line or comma-separated. Returns the complete history of all interactions with those numbers including timestamps, results, messages used, and caller IDs.</p>

        <h4>Combine Campaigns</h4>
        <p>Merge all campaign data from selected accounts into a single CSV file. This is useful for:</p>
        <ul style="margin-left: 16px; margin-bottom: 12px;">
          <li>Analyzing overall performance across multiple campaigns</li>
          <li>Running the Number Trend Analyzer for insights</li>
          <li>Identifying patterns in calling results</li>
        </ul>

        <h4>Bulk Campaign Export</h4>
        <p>Export each campaign as a separate CSV file, organized in folders by year and month. Useful for archiving and compliance purposes.</p>

        <h4>Output Options</h4>
        <ul style="margin-left: 16px;">
          <li><strong>CSV:</strong> Export to CSV files in ~/Downloads/VoApps Tools/</li>
          <li><strong>Database:</strong> Save to local DuckDB database for SQL queries</li>
          <li><strong>Both:</strong> Save to database AND create CSV files</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Trend Analyzer Info Modal -->
  <div id="trendAnalyzerModal" class="info-modal" onclick="if(event.target === this) hideInfoModal('trendAnalyzer')">
    <div class="info-modal-content">
      <div class="info-modal-header">
        <div class="info-modal-title">ðŸ“Š Number Trend Analyzer</div>
        <button class="info-modal-close" onclick="hideInfoModal('trendAnalyzer')">Ã—</button>
      </div>
      <div class="info-modal-body" style="font-size: 12px;">
        <h4>Overview</h4>
        <p>Generates a comprehensive Excel workbook with multiple analysis tabs showing calling patterns, success rates, and actionable insights.</p>

        <h4>Generated Tabs</h4>
        <ul style="margin-left: 16px; margin-bottom: 12px;">
          <li><strong>Report Overview:</strong> Summary, recommendations, and glossary</li>
          <li><strong>Global Insights (Msg & Caller):</strong> Message and caller number performance</li>
          <li><strong>Global Insights (Time):</strong> Hourly and daily success patterns</li>
          <li><strong>Call Cadence:</strong> Time intervals between calls to same number</li>
          <li><strong>Number Summary:</strong> Per-number stats, message usage, day distribution</li>
          <li><strong>Consecutive Unsuccessful:</strong> Numbers needing list hygiene attention</li>
          <li><strong>Glossary:</strong> Definitions of all columns and terms</li>
        </ul>

        <h4>Consecutive Unsuccessful Thresholds</h4>
        <p><strong>Min Count:</strong> Minimum consecutive unsuccessful attempts to flag (default: 4)</p>
        <p><strong>Min Days:</strong> Minimum time span of the unsuccessful run (default: 30 days)</p>

        <h4>Data Sources</h4>
        <ul style="margin-left: 16px;">
          <li><strong>With Combine:</strong> Automatically generate when running Combine Campaigns</li>
          <li><strong>From CSV:</strong> Upload a previously exported CSV file</li>
          <li><strong>From Database:</strong> Query your local database (uses Date Range filter)</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ACCOUNTS INFO MODAL -->
  <div id="accountsModal" class="info-modal" onclick="if(event.target === this) hideInfoModal('accounts')">
    <div class="info-modal-content">
      <div class="info-modal-header">
        <div class="info-modal-title">Accounts</div>
        <button class="info-modal-close" onclick="hideInfoModal('accounts')">Ã—</button>
      </div>
      <div class="info-modal-body" style="font-size: 12px;">
        <h4 style="margin-top:0;">Loading Accounts</h4>
        <p>Click <strong>Load from API</strong> to fetch accounts associated with your API key. Accounts are cached locally so you don't need to reload them each time.</p>

        <h4>Manual Entry</h4>
        <p>If you know an account ID, you can enter it directly and click <strong>Add</strong> to add it to your selection without loading all accounts.</p>

        <h4>Account Selection</h4>
        <ul style="margin-left: 16px;">
          <li>Click an account to toggle selection</li>
          <li>Use <strong>Select All</strong> / <strong>Deselect All</strong> to quickly modify selection</li>
          <li>The eye icon hides accounts you don't want to see in the list</li>
          <li>Use the search box to filter accounts by name or ID</li>
        </ul>

        <h4>Caching</h4>
        <p>Accounts are cached locally. The cache is cleared when:</p>
        <ul style="margin-left: 16px;">
          <li>You clear your API key</li>
          <li>You enter a new API key</li>
          <li>You manually click <strong>Load from API</strong></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- API KEY INFO MODAL -->
  <div id="apiKeyModal" class="info-modal" onclick="if(event.target === this) hideInfoModal('apiKey')">
    <div class="info-modal-content">
      <div class="info-modal-header">
        <div class="info-modal-title">API Key</div>
        <button class="info-modal-close" onclick="hideInfoModal('apiKey')">Ã—</button>
      </div>
      <div class="info-modal-body" style="font-size: 12px;">
        <h4 style="margin-top:0;">What is the API Key?</h4>
        <p>The API key authenticates your requests to the VoApps API. It's required to download campaign data and fetch account information.</p>

        <h4>Getting Your API Key</h4>
        <p>Contact VoApps support or your account manager to obtain an API key. The key is typically a long alphanumeric string.</p>
        <p style="margin-top: 8px;">
          <a href="#" onclick="if(window.voapps?.openUpdateUrl) window.voapps.openUpdateUrl('https://directdropvoicemail.voapps.com/api/index'); else window.open('https://directdropvoicemail.voapps.com/api/index', '_blank'); return false;" style="color: #FF4B7D; text-decoration: none; font-weight: 600;">
            ðŸ”— VoApps DirectDrop Portal
          </a>
        </p>

        <h4>Security</h4>
        <ul style="margin-left: 16px;">
          <li>Your API key is stored <strong>locally on your machine only</strong></li>
          <li>It is never sent to any servers other than VoApps</li>
          <li>The key is encrypted in local storage</li>
        </ul>

        <h4>Testing</h4>
        <p>After entering your API key, click <strong>Test</strong> to verify it works. A successful test will show your account details.</p>
      </div>
    </div>
  </div>

  <!-- REPORT HEADERS INFO MODAL -->
  <div id="reportHeadersModal" class="info-modal" onclick="if(event.target === this) hideInfoModal('reportHeaders')">
    <div class="info-modal-content">
      <div class="info-modal-header">
        <div class="info-modal-title">Report Headers</div>
        <button class="info-modal-close" onclick="hideInfoModal('reportHeaders')">Ã—</button>
      </div>
      <div class="info-modal-body" style="font-size: 12px;">
        <h4 style="margin-top:0;">Customizing CSV Columns</h4>
        <p>Select which columns to include in your CSV exports. This applies to all search types (Phone Number, Combine Campaigns, Bulk Export).</p>

        <h4>Column Groups</h4>
        <ul style="margin-left: 16px;">
          <li><strong>Core:</strong> Basic identifiers (number, account_id, campaign_id, campaign_name)</li>
          <li><strong>Metadata:</strong> Additional info (caller_number, message details)</li>
          <li><strong>Results:</strong> Outcome data (voapps_result, voapps_code, timestamp, URL)</li>
        </ul>

        <h4>Quick Actions</h4>
        <p>Each column group has <strong>all</strong> and <strong>clear</strong> buttons to quickly select or deselect all columns in that group.</p>

        <h4>Column Definitions</h4>
        <table style="font-size: 10px; width: 100%; border-collapse: collapse; margin-top: 8px;">
          <tr style="border-bottom: 1px solid #eee;"><td style="padding: 4px 0;"><strong>number</strong></td><td>Phone number called</td></tr>
          <tr style="border-bottom: 1px solid #eee;"><td style="padding: 4px 0;"><strong>account_id</strong></td><td>VoApps account identifier</td></tr>
          <tr style="border-bottom: 1px solid #eee;"><td style="padding: 4px 0;"><strong>campaign_id</strong></td><td>Campaign identifier</td></tr>
          <tr style="border-bottom: 1px solid #eee;"><td style="padding: 4px 0;"><strong>campaign_name</strong></td><td>Human-readable campaign name</td></tr>
          <tr style="border-bottom: 1px solid #eee;"><td style="padding: 4px 0;"><strong>caller_number</strong></td><td>Caller ID used for the call</td></tr>
          <tr style="border-bottom: 1px solid #eee;"><td style="padding: 4px 0;"><strong>message_id</strong></td><td>Message template identifier</td></tr>
          <tr style="border-bottom: 1px solid #eee;"><td style="padding: 4px 0;"><strong>voapps_result</strong></td><td>Call result (success, failed, etc.)</td></tr>
          <tr style="border-bottom: 1px solid #eee;"><td style="padding: 4px 0;"><strong>voapps_code</strong></td><td>Specific result code</td></tr>
          <tr><td style="padding: 4px 0;"><strong>voapps_timestamp</strong></td><td>When the call was made (UTC)</td></tr>
        </table>
      </div>
    </div>
  </div>

  <!-- DATABASE INFO MODAL -->
  <div id="databaseModal" class="info-modal" onclick="if(event.target === this) hideInfoModal('database')">
    <div class="info-modal-content">
      <div class="info-modal-header">
        <div class="info-modal-title">Local Database</div>
        <button class="info-modal-close" onclick="hideInfoModal('database')">Ã—</button>
      </div>
      <div class="info-modal-body" style="font-size: 12px;">
        <h4 style="margin-top:0;">About DuckDB</h4>
        <p>VoApps Tools uses DuckDB, an embedded analytical database, to store campaign data locally. This enables fast SQL queries and efficient data analysis.</p>

        <h4>Output Modes</h4>
        <p>Use the buttons on the home screen to choose how search results are stored:</p>
        <ul style="margin-left: 16px;">
          <li><strong>CSV:</strong> Export results to CSV files only</li>
          <li><strong>Database:</strong> Save to local database only</li>
          <li><strong>Both:</strong> Save to database AND create CSV files</li>
        </ul>

        <h4>Database Actions</h4>
        <ul style="margin-left: 16px;">
          <li><strong>Refresh:</strong> Update statistics (record count, size, etc.)</li>
          <li><strong>Export:</strong> Export entire database to a CSV file</li>
          <li><strong>Compact:</strong> Optimize database file size</li>
          <li><strong>Clear:</strong> Delete all records (creates backup first)</li>
        </ul>

        <h4>SQL Queries</h4>
        <p>Run custom SQL queries against your data. The main table is <code>campaign_results</code>. Use the sample queries dropdown for common queries.</p>

        <h4>Number Trend Analyzer</h4>
        <p>Run the Number Trend Analyzer directly from database data. Uses your current date range selection to filter records.</p>

        <h4>Storage Location</h4>
        <p><code>~/Downloads/VoApps Tools/campaign_data.duckdb</code></p>
      </div>
    </div>
  </div>

  <div id="helpModal" class="info-modal" onclick="if(event.target === this) hideInfoModal('help')">
    <div class="info-modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
      <div class="info-modal-header">
        <div class="info-modal-title">VoApps Tools v3.1.0 â€” Help</div>
        <button class="info-modal-close" onclick="hideInfoModal('help')">Ã—</button>
      </div>
      <div class="info-modal-body" style="font-size: 12px;">
        <h4 style="margin-top:0;">ðŸ“‹ Overview</h4>
        <p>VoApps Tools is a desktop application for analyzing DirectDrop Voicemail campaign data. It connects to the VoApps API to download campaign results and provides powerful analysis features.</p>

        <h4>ðŸ”‘ Setup</h4>
        <ol style="margin-left: 16px;">
          <li>Go to the <strong>API Key</strong> section (key icon in sidebar)</li>
          <li>Paste your VoApps API key and click <strong>Save</strong></li>
          <li>Click <strong>Test</strong> to verify the connection</li>
          <li>Go to <strong>Accounts</strong> and click <strong>Load</strong> to fetch your accounts</li>
          <li>Select the accounts you want to analyze</li>
        </ol>

        <h4>ðŸ” Search Modes</h4>
        <ul style="margin-left: 16px;">
          <li><strong>Phone Number Search:</strong> Find all campaign interactions for specific phone numbers. Enter numbers (one per line or comma-separated) and get a complete history.</li>
          <li><strong>Combine Campaigns:</strong> Merge all campaign data from selected accounts into a single CSV. Optionally run the Number Trend Analyzer for Excel insights.</li>
          <li><strong>Bulk Export:</strong> Export each campaign as a separate CSV file, organized by year/month folders. Useful for archiving.</li>
        </ul>

        <h4>ðŸ’¾ Output Modes</h4>
        <ul style="margin-left: 16px;">
          <li><strong>CSV Only:</strong> Export results to CSV files in ~/Downloads/VoApps Tools/</li>
          <li><strong>Database Only:</strong> Save to local DuckDB database for fast SQL queries</li>
          <li><strong>Both:</strong> Save to database AND create CSV files</li>
        </ul>

        <h4>ðŸ“Š Number Trend Analyzer</h4>
        <p>Available in Combine Campaigns mode. Generates an Excel workbook with:</p>
        <ul style="margin-left: 16px;">
          <li>Report Overview with date range and thresholds</li>
          <li>Global Insights by Message &amp; Caller Number</li>
          <li>Global Insights by Time (hourly/daily patterns)</li>
          <li>Call Cadence analysis (time between attempts)</li>
          <li>Number Summary (per-number statistics)</li>
          <li>Consecutive Unsuccessful patterns</li>
        </ul>
        <p>You can also upload a CSV directly to run analysis without fetching from VoApps.</p>

        <h4>ðŸ—„ï¸ Local Database</h4>
        <p>DuckDB stores results locally for fast querying. Use the SQL Query interface to run custom queries. Features include:</p>
        <ul style="margin-left: 16px;">
          <li><strong>Refresh:</strong> Update database statistics</li>
          <li><strong>Export:</strong> Export entire database to CSV</li>
          <li><strong>Compact:</strong> Optimize database file size</li>
          <li><strong>Clear:</strong> Delete all records (creates backup first)</li>
        </ul>

        <h4>ðŸ“ Output Location</h4>
        <p><code>~/Downloads/VoApps Tools/</code></p>
        <ul style="margin-left: 16px;">
          <li><code>Output/Phone Number History/</code> â€” Phone search results</li>
          <li><code>Output/Combine Campaigns/</code> â€” Combined CSVs and analysis files</li>
          <li><code>Output/Bulk Campaign Export/</code> â€” Individual campaign CSVs by date</li>
          <li><code>Logs/</code> â€” Operation logs and error files</li>
        </ul>

        <h4 style="border-top: 1px solid #e0e0e0; padding-top: 12px; margin-top: 16px;">ðŸ“ Release Notes</h4>
        <p><strong>v3.1.0 - Live Logging Edition</strong></p>
        <ul style="margin-left: 16px;">
          <li>Live log streaming with real-time progress</li>
          <li>New sidebar navigation UI</li>
          <li>Bulk export CSV enrichment (caller_number, message_id)</li>
          <li>Cancel button for running operations</li>
          <li>Log filtering with next/previous navigation</li>
          <li>CSV upload for standalone trend analysis</li>
        </ul>
        <p><strong>v3.0.0 - DuckDB Edition</strong></p>
        <ul style="margin-left: 16px;">
          <li>Local DuckDB database for fast analysis</li>
          <li>Three output modes: CSV, Database, Both</li>
          <li>SQL query interface</li>
          <li>Smart duplicate handling via MD5 row IDs</li>
        </ul>

        <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #e0e0e0; text-align: center;">
          <a href="#" onclick="if(window.voapps?.openUpdateUrl) window.voapps.openUpdateUrl('https://github.com/eiznem/voapps-tools'); else window.open('https://github.com/eiznem/voapps-tools', '_blank'); return false;" style="color: #FF4B7D; text-decoration: none; font-weight: 600;">
            ðŸ”— View on GitHub (eiznem/voapps-tools)
          </a>
        </div>
      </div>
    </div>
  </div>

  <div id="updateModal" class="info-modal" onclick="if(event.target === this) hideInfoModal('update')">
    <div class="info-modal-content">
      <div class="info-modal-header">
        <div class="info-modal-title" id="updateModalTitle">Update</div>
        <button class="info-modal-close" onclick="hideInfoModal('update')">Ã—</button>
      </div>
      <div class="info-modal-body" id="updateModalBody">
        <p>Checking...</p>
      </div>
    </div>
  </div>

  <!-- TOAST CONTAINER -->
  <div id="toastContainer" class="toast-container"></div>

  <script>
    // ============================================================================
    // GLOBALS
    // ============================================================================
    const $ = id => document.getElementById(id);
    const KEY_STORE = 'voapps_api_key';
    const SETTINGS_STORE = 'voapps_settings';

    let selectedAccounts = new Set();
    let allAccounts = [];
    let hiddenAccountIds = new Set();
    let currentJobId = null;
    let isLocked = false;
    let isPaused = false;
    let eventSource = null;
    let outputMode = 'csv';
    let currentFilterIndex = -1;
    let filteredMatches = [];

    // ============================================================================
    // VIEW SWITCHING
    // ============================================================================
    let currentDrawer = null;

    function switchView(viewName) {
      // Update sidebar active state
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === viewName);
      });

      if (viewName === 'home') {
        // Close any open drawer and go to home
        closeDrawer();
      } else {
        // Open the corresponding drawer
        openDrawer(viewName);
      }
    }

    function openDrawer(drawerName) {
      const drawerId = `drawer${drawerName.charAt(0).toUpperCase() + drawerName.slice(1)}`;
      const drawer = $(drawerId);
      const overlay = $('drawerOverlay');

      if (!drawer) return;

      // Close any currently open drawer first
      document.querySelectorAll('.drawer-panel.open').forEach(d => {
        d.classList.remove('open');
      });

      // Open the new drawer
      drawer.classList.add('open');
      overlay.classList.add('visible');
      currentDrawer = drawerName;

      // Special handling for output drawer
      if (drawerName === 'output') {
        refreshDatabaseStats();
      }
    }

    function closeDrawer() {
      const overlay = $('drawerOverlay');

      // Close all drawers
      document.querySelectorAll('.drawer-panel.open').forEach(d => {
        d.classList.remove('open');
      });

      overlay.classList.remove('visible');
      currentDrawer = null;

      // Reset sidebar to show home as active
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === 'home');
      });
    }

    // Toggle drawer - click same icon again to close
    function toggleDrawer(viewName) {
      if (currentDrawer === viewName) {
        closeDrawer();
      } else {
        switchView(viewName);
      }
    }

    // ============================================================================
    // RESIZE HANDLES
    // ============================================================================
    function initHomeResizeHandle() {
      const handle = $('homeResizeHandle');
      const left = $('homeLeft');
      const right = $('homeRight');

      if (!handle || !left || !right) return;

      let isResizing = false;
      let startX = 0;
      let startWidth = 0;

      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = left.offsetWidth;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const delta = e.clientX - startX;
        const newWidth = Math.min(Math.max(startWidth + delta, 380), 800);
        left.style.width = newWidth + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
          localStorage.setItem('homePanelWidth', left.style.width);
        }
      });

      // Restore saved width
      const savedWidth = localStorage.getItem('homePanelWidth');
      if (savedWidth) left.style.width = savedWidth;
    }

    function initAccountsResizeHandle() {
      const handle = $('accountsResizeHandle');
      const left = $('accountsColumnLeft');
      const right = $('accountsColumnRight');

      if (!handle || !left || !right) return;

      let isResizing = false;
      let startX = 0;
      let startLeftWidth = 0;

      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startLeftWidth = left.offsetWidth;
        handle.style.background = '#FF4B7D';
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const parent = left.parentElement;
        const totalWidth = parent.offsetWidth - 10;
        const delta = e.clientX - startX;
        const newLeftWidth = Math.min(Math.max(startLeftWidth + delta, 100), totalWidth - 100);
        const leftPercent = (newLeftWidth / totalWidth) * 100;
        left.style.flex = `0 0 ${leftPercent}%`;
        right.style.flex = `0 0 ${100 - leftPercent}%`;
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          handle.style.background = '';
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    }

    // ============================================================================
    // TOAST
    // ============================================================================
    function showToast(message, type = 'info', duration = 3000) {
      const container = $('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icons = { success: 'âœ“', error: 'âœ•', info: 'â„¹' };

      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || 'â„¹'}</span>
        <span class="toast-message">${message}</span>
        <span class="toast-close" onclick="this.parentElement.remove()">Ã—</span>
      `;

      container.appendChild(toast);

      if (duration > 0) {
        setTimeout(() => {
          toast.style.animation = 'slideInRight 0.3s ease reverse';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }
    }

    // ============================================================================
    // OUTPUT MODE
    // ============================================================================
    function setOutputMode(mode) {
      outputMode = mode;

      // Update button active states (both old .output-mode-btn and new .output-mode-btn-sm)
      document.querySelectorAll('.output-mode-btn, .output-mode-btn-sm').forEach(btn => btn.classList.remove('active'));

      if (mode === 'csv') {
        $('outputModeCSV')?.classList.add('active');
      } else if (mode === 'database') {
        $('outputModeDatabase')?.classList.add('active');
        refreshDatabaseStats();
      } else {
        $('outputModeBoth')?.classList.add('active');
        refreshDatabaseStats();
      }

      const settings = JSON.parse(localStorage.getItem(SETTINGS_STORE) || '{}');
      settings.outputMode = mode;
      localStorage.setItem(SETTINGS_STORE, JSON.stringify(settings));
      log(`Output mode: ${mode}`);
    }

    // ============================================================================
    // DATABASE
    // ============================================================================
    async function refreshDatabaseStats() {
      try {
        const response = await fetch('/api/database/stats');
        const data = await response.json();

        if (!data.ok) {
          log('Database stats error');
          return;
        }

        const stats = data.stats;
        const totalEl = $('dbTotalRows');
        const numbersEl = $('dbUniqueNumbers');
        const campaignsEl = $('dbUniqueCampaigns');
        const rangeEl = $('dbDateRange');
        const sizeEl = $('dbSize');

        if (totalEl) totalEl.textContent = (stats.totalRows || 0).toLocaleString();
        if (numbersEl) numbersEl.textContent = (stats.uniqueNumbers || 0).toLocaleString();
        if (campaignsEl) campaignsEl.textContent = (stats.uniqueCampaigns || 0).toLocaleString();

        if (rangeEl) {
          if (stats.dateRange?.min_date && stats.dateRange?.max_date) {
            rangeEl.textContent = `${stats.dateRange.min_date} to ${stats.dateRange.max_date}`;
          } else {
            rangeEl.textContent = 'â€”';
          }
        }

        if (sizeEl) sizeEl.textContent = ((stats.dbSize || 0) / (1024 * 1024)).toFixed(2) + ' MB';
      } catch (e) {
        log(`Stats error: ${e.message}`);
      }
    }

    async function clearDatabase() {
      // Show confirmation with options
      const createBackup = confirm(
        'Clear ALL database records?\n\n' +
        'â€¢ A backup will be created before clearing\n' +
        'â€¢ The database will be compacted to reclaim disk space\n\n' +
        'Click OK to proceed, Cancel to abort.'
      );
      if (!createBackup && !confirm('Are you sure? Click OK to skip backup (not recommended).')) return;

      try {
        log('Clearing database...');
        showToast('Clearing database...', 'info', 10000);

        const response = await fetch('/api/database/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ createBackup })
        });
        const data = await response.json();

        if (data.ok) {
          const message = data.rowCount > 0
            ? `Cleared ${data.rowCount.toLocaleString()} rows. Space reclaimed.`
            : 'Database was already empty.';
          log(message);
          if (data.backupPath) {
            log(`Backup saved: ${data.backupPath}`);
          }
          showToast(message, 'success', 4000);
          await refreshDatabaseStats();
        } else throw new Error(data.error);
      } catch (e) {
        showToast(`Error: ${e.message}`, 'error');
      }
    }

    async function compactDatabase() {
      try {
        log('Compacting...');
        const response = await fetch('/api/database/compact', { method: 'POST' });
        const data = await response.json();
        if (data.ok) {
          log('Compacted');
          showToast('Database compacted', 'success');
          await refreshDatabaseStats();
        } else throw new Error(data.error);
      } catch (e) {
        showToast(`Error: ${e.message}`, 'error');
      }
    }

    async function exportDatabase() {
      try {
        log('Exporting...');
        const response = await fetch('/api/database/export', { method: 'POST' });
        const data = await response.json();
        if (data.ok) {
          log(`Exported ${data.rowCount.toLocaleString()} rows`);
          showToast(`Exported ${data.rowCount.toLocaleString()} rows`, 'success');
          if (window.voapps) await refreshArtifacts();
        } else throw new Error(data.error);
      } catch (e) {
        showToast(`Error: ${e.message}`, 'error');
      }
    }

    async function runQuery() {
      const sql = $('sqlQuery').value.trim();
      if (!sql) return alert('Enter a query');
      try {
        const response = await fetch('/api/database/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sql })
        });
        const data = await response.json();
        if (data.ok) {
          $('queryResultsContent').textContent = JSON.stringify(data.rows, null, 2);
          $('queryResults').classList.add('show');
          $('copyQueryBtn').style.display = 'block';
        } else {
          $('queryResultsContent').textContent = `ERROR: ${data.error}`;
          $('queryResults').classList.add('show');
          $('copyQueryBtn').style.display = 'none';
        }
      } catch (e) {
        $('queryResultsContent').textContent = `ERROR: ${e.message}`;
        $('queryResults').classList.add('show');
      }
    }

    function loadSampleQuery(type) {
      const queries = {
        recent: `SELECT number, voapps_result, campaign_name, voapps_timestamp FROM campaign_results ORDER BY voapps_timestamp DESC LIMIT 100`,
        'by-account': `SELECT account_id, COUNT(*) as total FROM campaign_results GROUP BY account_id ORDER BY total DESC`,
        'success-rate': `SELECT campaign_name, COUNT(*) as total, SUM(CASE WHEN voapps_result = 'DELIVERED' THEN 1 ELSE 0 END) as delivered FROM campaign_results GROUP BY campaign_name LIMIT 50`,
        duplicates: `SELECT number, COUNT(*) as count FROM campaign_results GROUP BY number HAVING COUNT(*) > 1 ORDER BY count DESC LIMIT 100`
      };
      if (type && queries[type]) {
        $('sqlQuery').value = queries[type];
        $('sampleQueries').value = '';
      }
    }

    async function copyQueryResults() {
      try {
        await navigator.clipboard.writeText($('queryResultsContent').textContent);
        showToast('Copied', 'success');
      } catch (e) {
        showToast('Failed', 'error');
      }
    }

    function saveCurrentQuery() {
      const query = $('sqlQuery').value.trim();
      if (!query) return alert('No query');
      const name = prompt('Query name:');
      if (!name) return;
      const saved = JSON.parse(localStorage.getItem('savedQueries') || '{}');
      saved[name] = query;
      localStorage.setItem('savedQueries', JSON.stringify(saved));
      showToast(`Saved: ${name}`, 'success');
    }

    // ============================================================================
    // LOGGING
    // ============================================================================
    function log(msg) {
      const logEl = $('logContent');
      if (!logEl) {
        console.log('[log]', msg);
        return;
      }
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.textContent = `[${time}] ${msg}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(title, state) {
      $('statusTitle').textContent = title;
      const dot = $('statusDot');
      if (state === 'running') dot.style.background = '#f59e0b';
      else if (state === 'done') dot.style.background = '#22c55e';
      else if (state === 'error') dot.style.background = '#ef4444';
      else dot.style.background = '#22c55e';
    }

    function setLocked(locked) {
      isLocked = locked;
      $('runBtn').disabled = locked;
      $('pauseBtn').disabled = !locked;
      $('cancelBtn').style.display = locked ? 'inline-flex' : 'none';

      const progressPanel = $('progressPanel');
      if (locked) {
        progressPanel.classList.add('visible');
      } else {
        progressPanel.classList.remove('visible');
        isPaused = false;
        const pauseBtn = $('pauseBtn');
        pauseBtn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>Pause';
        $('progressBar').style.width = '0%';
      }
    }

    function updateProgress(current, total, text) {
      const progressBar = $('progressBar');
      const progressPercent = $('progressPercent');

      if (current < 0) {
        // Indeterminate state - show pulsing animation
        progressBar.style.width = '100%';
        progressBar.classList.add('indeterminate');
        progressPercent.textContent = '';
        $('progressText').textContent = text || 'Processing...';
      } else {
        progressBar.classList.remove('indeterminate');
        const percent = total > 0 ? Math.round((current / total) * 100) : 0;
        progressBar.style.width = `${percent}%`;
        progressPercent.textContent = `${percent}%`;
        $('progressText').textContent = text || `${current}/${total}`;
      }
    }

    // ============================================================================
    // LOG FILTER
    // ============================================================================
    function initLogFilter() {
      const filterInput = $('logFilterInput');
      const logContent = $('logContent');
      const filterCount = $('logFilterCount');
      const prevBtn = $('logFilterPrev');
      const nextBtn = $('logFilterNext');

      if (!filterInput || !logContent) return;

      filterInput.addEventListener('input', () => {
        const query = filterInput.value.toLowerCase().trim();
        const entries = logContent.querySelectorAll('.log-entry');
        filteredMatches = [];
        currentFilterIndex = -1;

        entries.forEach(entry => {
          const originalText = entry.getAttribute('data-original') || entry.textContent;
          if (!entry.hasAttribute('data-original')) {
            entry.setAttribute('data-original', entry.textContent);
          }
          entry.classList.remove('current-match');

          if (!query) {
            entry.classList.remove('filtered');
            entry.innerHTML = originalText;
          } else {
            const text = originalText.toLowerCase();
            if (text.includes(query)) {
              entry.classList.remove('filtered');
              const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
              entry.innerHTML = originalText.replace(regex, '<mark>$1</mark>');
              filteredMatches.push(entry);
            } else {
              entry.classList.add('filtered');
            }
          }
        });

        if (query && filteredMatches.length > 0) {
          filterCount.textContent = `${filteredMatches.length}`;
          currentFilterIndex = 0;
          highlightMatch();
        } else if (query) {
          filterCount.textContent = '0';
        } else {
          filterCount.textContent = '';
        }
      });

      prevBtn.addEventListener('click', () => {
        if (filteredMatches.length === 0) return;
        currentFilterIndex = (currentFilterIndex - 1 + filteredMatches.length) % filteredMatches.length;
        highlightMatch();
      });

      nextBtn.addEventListener('click', () => {
        if (filteredMatches.length === 0) return;
        currentFilterIndex = (currentFilterIndex + 1) % filteredMatches.length;
        highlightMatch();
      });

      filterInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); nextBtn.click(); }
        else if (e.key === 'Escape') { filterInput.value = ''; filterInput.dispatchEvent(new Event('input')); }
      });
    }

    function highlightMatch() {
      filteredMatches.forEach((e, i) => e.classList.toggle('current-match', i === currentFilterIndex));
      if (filteredMatches[currentFilterIndex]) {
        filteredMatches[currentFilterIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        $('logFilterCount').textContent = `${currentFilterIndex + 1}/${filteredMatches.length}`;
      }
    }

    // ============================================================================
    // CANCEL
    // ============================================================================
    function cancelOperation() {
      if (eventSource) { eventSource.close(); eventSource = null; }
      setLocked(false);
      setStatus('Cancelled', 'idle');
      showToast('Cancelled', 'info');
      log('Cancelled by user');
    }

    // ============================================================================
    // SEARCH TYPE
    // ============================================================================
    const searchTypeDescriptions = {
      phone: "Search campaigns for specific phone numbers.",
      combine: "Merge all campaign data into a single CSV.",
      "bulk-export": "Export each campaign as a separate CSV."
    };

    $('searchTypeDropdown').onchange = () => {
      const val = $('searchTypeDropdown').value;
      $('searchTypeDescription').textContent = searchTypeDescriptions[val] || "";
      $('phoneInputContainer').classList.toggle('visible', val === 'phone');
      $('trendAnalyzerContainer').classList.toggle('visible', val === 'combine');

      const runBtn = $('runBtn');
      if (val === 'bulk-export') runBtn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Export';
      else if (val === 'combine') runBtn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>Combine';
      else runBtn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>Run';

      saveSettings();
    };

    // Trend Analyzer radio button handling
    function updateTrendSourceUI() {
      const source = document.querySelector('input[name="trendSource"]:checked')?.value;
      const uploadBtn = $('uploadCsvBtn');
      const uploadedName = $('uploadedFileName');
      const runBtn = $('runAnalyzerBtn');
      const dbBtn = $('runDbAnalysisBtn');
      const clearLink = $('clearTrendSelection');

      // Hide all action buttons first
      if (uploadBtn) uploadBtn.style.display = 'none';
      if (uploadedName) uploadedName.style.display = 'none';
      if (runBtn) runBtn.style.display = 'none';
      if (dbBtn) dbBtn.style.display = 'none';

      // Show/hide clear link based on selection
      if (clearLink) clearLink.style.display = source ? 'inline' : 'none';

      if (source === 'csv') {
        if (uploadBtn) uploadBtn.style.display = 'inline-flex';
        if (uploadedCsvFile && uploadedName) {
          uploadedName.style.display = 'inline';
          if (runBtn) runBtn.style.display = 'inline-flex';
        }
      } else if (source === 'database') {
        if (dbBtn) dbBtn.style.display = 'inline-flex';
      }
      // 'combine' source shows no extra buttons - it triggers with the Combine action
      // no source (cleared) also shows no buttons

      // Save selection
      const saved = JSON.parse(localStorage.getItem(SETTINGS_STORE) || '{}');
      saved.trendSource = source || null;
      localStorage.setItem(SETTINGS_STORE, JSON.stringify(saved));
    }

    // Clear trend source selection
    window.clearTrendSelection = function() {
      document.querySelectorAll('input[name="trendSource"]').forEach(radio => {
        radio.checked = false;
      });
      updateTrendSourceUI();
    };

    // Attach event listeners to radio buttons
    document.querySelectorAll('input[name="trendSource"]').forEach(radio => {
      radio.addEventListener('change', updateTrendSourceUI);
    });

    // Initialize from saved settings
    function initTrendSourceUI() {
      const saved = JSON.parse(localStorage.getItem(SETTINGS_STORE) || '{}');
      const source = saved.trendSource;
      if (source) {
        const radio = document.querySelector(`input[name="trendSource"][value="${source}"]`);
        if (radio) radio.checked = true;
      }
      updateTrendSourceUI();
    }

    $('uploadCsvBtn').onclick = () => $('csvFileUpload').click();

    let uploadedCsvFile = null;

    $('csvFileUpload').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        uploadedCsvFile = file;
        $('uploadedFileName').textContent = file.name;
        $('uploadedFileName').title = file.name; // Show full name on hover
        log(`CSV loaded: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
        updateTrendSourceUI(); // Update button visibility
      } else {
        uploadedCsvFile = null;
        $('uploadedFileName').textContent = '';
        updateTrendSourceUI();
      }
    };

    $('runAnalyzerBtn').onclick = async () => {
      if (!uploadedCsvFile) {
        showToast('No CSV file selected', 'error');
        return;
      }

      const minConsec = parseInt($('minConsecUnsuccessful').value) || 4;
      const minSpan = parseInt($('minRunSpanDays').value) || 30;

      setLocked(true);
      setStatus('Analyzing...', 'running');
      log(`Starting Number Trend Analyzer...`);
      log(`  File: ${uploadedCsvFile.name}`);
      log(`  Min Consecutive: ${minConsec}`);
      log(`  Min Days Span: ${minSpan}`);

      try {
        const formData = new FormData();
        formData.append('csv', await uploadedCsvFile.text());
        formData.append('min_consec_unsuccessful', minConsec);
        formData.append('min_run_span_days', minSpan);

        log('Uploading and processing CSV...');
        updateProgress(-1, 100, 'Analyzing data...'); // -1 = indeterminate

        const response = await fetch('/api/analyze-csv', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (!response.ok || !data.ok) {
          throw new Error(data.error || 'Analysis failed');
        }

        updateProgress(100, 100, 'Complete');
        setLocked(false);
        setStatus('Done', 'done');
        playCompletionSound();

        log(`âœ“ Analysis complete!`);
        log(`  Output: ${data.artifacts?.analysisPath || 'Excel file generated'}`);
        showToast('Analysis complete!', 'success', 5000);

        if (window.voapps) await refreshArtifacts();

      } catch (e) {
        setLocked(false);
        setStatus('Error', 'error');
        log(`ERROR: ${e.message}`);
        showToast(`Analysis failed: ${e.message}`, 'error', 5000);
      }
    };

    // Run Database Trend Analysis function (shared by both drawer and home panel)
    window.runDbTrendAnalysis = async () => {
      const minConsec = parseInt($('minConsecUnsuccessful').value) || 4;
      const minSpan = parseInt($('minRunSpanDays').value) || 30;
      const clientPrefix = ($('clientPrefix')?.value || '').trim();

      // Use date range from the main form
      const startDate = $('startDate').value;
      const endDate = $('endDate').value;

      if (!startDate || !endDate) {
        showToast('Please select a date range', 'error');
        return;
      }

      setLocked(true);
      setStatus('Analyzing Database...', 'running');
      log(`Starting Database Trend Analysis...`);
      log(`  Date Range: ${startDate} to ${endDate}`);
      log(`  Min Consecutive: ${minConsec}`);
      log(`  Min Days Span: ${minSpan}`);
      if (clientPrefix) log(`  Client Prefix: ${clientPrefix}`);

      try {
        updateProgress(0, 100, 'Querying database...');

        const response = await fetch('/api/analyze-database', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            start_date: startDate,
            end_date: endDate,
            min_consec_unsuccessful: minConsec,
            min_run_span_days: minSpan,
            client_prefix: clientPrefix
          })
        });

        const data = await response.json();

        if (!response.ok || !data.ok) {
          throw new Error(data.error || 'Analysis failed');
        }

        updateProgress(100, 100, 'Complete');
        setLocked(false);
        setStatus('Done', 'done');
        playCompletionSound();

        log(`âœ“ Database analysis complete!`);
        log(`  Rows analyzed: ${data.rowCount?.toLocaleString() || 0}`);
        log(`  Output: ${data.artifacts?.analysisPath || 'Excel file generated'}`);
        showToast('Database analysis complete!', 'success', 5000);

        if (window.voapps) await refreshArtifacts();

      } catch (e) {
        setLocked(false);
        setStatus('Error', 'error');
        log(`ERROR: ${e.message}`);
        showToast(`Analysis failed: ${e.message}`, 'error', 5000);
      }
    };

    // Database Analysis Button (from trend analyzer radio button)
    if ($('runDbAnalysisBtn')) {
      $('runDbAnalysisBtn').onclick = () => window.runDbTrendAnalysis();
    }

    // ============================================================================
    // DATE PRESETS
    // ============================================================================
    $('datePreset').onchange = () => {
      const preset = $('datePreset').value;
      if (!preset) return;
      const end = new Date();
      const start = new Date(end);
      if (preset.startsWith('months_')) start.setMonth(start.getMonth() - parseInt(preset.split('_')[1]));
      else if (preset.startsWith('years_')) start.setFullYear(start.getFullYear() - parseInt(preset.split('_')[1]));
      $('startDate').value = start.toISOString().slice(0, 10);
      $('endDate').value = end.toISOString().slice(0, 10);
      saveSettings();
    };

    (() => {
      const today = new Date();
      const twoMonthsAgo = new Date(today);
      twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
      $('startDate').value = twoMonthsAgo.toISOString().slice(0, 10);
      $('endDate').value = today.toISOString().slice(0, 10);
    })();

    // ============================================================================
    // API KEY
    // ============================================================================
    $('apiKey').value = localStorage.getItem(KEY_STORE) || '';

    $('saveKeyBtn').onclick = () => {
      const oldKey = localStorage.getItem(KEY_STORE) || '';
      const newKey = $('apiKey').value;
      localStorage.setItem(KEY_STORE, newKey);
      log('API key saved');
      showToast('Saved', 'success');

      // Clear account cache if API key changed
      if (oldKey && oldKey !== newKey) {
        clearAccountCache();
        renderAccounts();
        log('Account cache cleared (API key changed)');
      }
    };

    $('clearKeyBtn').onclick = () => {
      $('apiKey').value = '';
      localStorage.removeItem(KEY_STORE);
      clearAccountCache();
      renderAccounts();
      log('API key and accounts cleared');
    };

    $('pingBtn').onclick = async () => {
      const apiKey = $('apiKey').value || localStorage.getItem(KEY_STORE);
      if (!apiKey) {
        showToast('No API key entered', 'error');
        log('ERROR: No API key to test');
        return;
      }

      try {
        log('Testing API key...');
        const resp = await fetch('/api/accounts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: apiKey })
        });
        const data = await resp.json();

        if (resp.ok && data.ok) {
          const count = data.accounts?.length || 0;
          log(`âœ“ API key valid! Found ${count} accounts`);
          showToast(`Valid! ${count} accounts`, 'success');
        } else {
          throw new Error(data.error || 'Invalid API key');
        }
      } catch (e) {
        log(`ERROR: ${e.message}`);
        showToast(`Failed: ${e.message}`, 'error');
      }
    };

    $('toggleApiKeyVisibility').onclick = () => {
      const input = $('apiKey');
      if (input.type === 'password') {
        input.type = 'text';
        setTimeout(() => { input.type = 'password'; }, 3000);
      } else {
        input.type = 'password';
      }
    };

    // ============================================================================
    // ACCOUNTS
    // ============================================================================
    const ACCOUNTS_CACHE_KEY = 'voapps_accounts_cache';

    // Load accounts from API
    async function loadAccountsFromApi() {
      const apiKey = $('apiKey').value || localStorage.getItem(KEY_STORE);
      if (!apiKey) { log('ERROR: No API key'); return; }

      log('Loading accounts from API...');

      const resp = await fetch('/api/accounts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ api_key: apiKey })
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) throw new Error(data.error || 'Failed');

      const activeAccounts = data.accounts || [];

      let hiddenAccounts = [];
      try {
        const hiddenResp = await fetch('/api/accounts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: apiKey, filter: 'hidden' })
        });
        const hiddenData = await hiddenResp.json();
        if (hiddenResp.ok && hiddenData.ok) {
          hiddenAccounts = hiddenData.accounts || [];
          hiddenAccountIds = new Set(hiddenAccounts.map(a => String(a.id)));
        }
      } catch(e) {}

      allAccounts = [...activeAccounts, ...hiddenAccounts];

      // Cache accounts for this API key
      const cacheData = {
        apiKeyHash: hashApiKey(apiKey),
        accounts: allAccounts,
        hiddenIds: Array.from(hiddenAccountIds),
        timestamp: Date.now()
      };
      localStorage.setItem(ACCOUNTS_CACHE_KEY, JSON.stringify(cacheData));

      return allAccounts;
    }

    // Simple hash for API key to detect changes without storing the key
    function hashApiKey(key) {
      let hash = 0;
      for (let i = 0; i < key.length; i++) {
        const char = key.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash.toString(36);
    }

    // Load accounts from cache if available and valid
    function loadAccountsFromCache() {
      try {
        const cached = localStorage.getItem(ACCOUNTS_CACHE_KEY);
        if (!cached) return false;

        const cacheData = JSON.parse(cached);
        const currentApiKey = $('apiKey').value || localStorage.getItem(KEY_STORE);

        if (!currentApiKey) return false;

        // Check if cache is for current API key
        if (cacheData.apiKeyHash !== hashApiKey(currentApiKey)) {
          localStorage.removeItem(ACCOUNTS_CACHE_KEY);
          return false;
        }

        // Restore from cache
        allAccounts = cacheData.accounts || [];
        hiddenAccountIds = new Set(cacheData.hiddenIds || []);

        if (allAccounts.length > 0) {
          renderAccounts();
          log(`Restored ${allAccounts.length} accounts from cache`);
          return true;
        }
      } catch (e) {
        console.error('Cache load error:', e);
      }
      return false;
    }

    // Clear account cache (called when API key changes)
    function clearAccountCache() {
      localStorage.removeItem(ACCOUNTS_CACHE_KEY);
      allAccounts = [];
      hiddenAccountIds.clear();
      selectedAccounts.clear();
    }

    $('loadAccountsBtn').onclick = async () => {
      try {
        await loadAccountsFromApi();
        renderAccounts();
        log(`Loaded ${allAccounts.length} accounts`);
        showToast(`${allAccounts.length} accounts`, 'success');
      } catch(e) {
        log(`ERROR: ${e.message}`);
        showToast(`Error: ${e.message}`, 'error');
      }
    };

    function renderAccounts() {
      const container = $('accountsContainer');
      const leftCol = $('accountsColumnLeft');
      const rightCol = $('accountsColumnRight');

      const validIds = new Set(allAccounts.map(a => String(a.id)));
      const oldSel = new Set(selectedAccounts);
      selectedAccounts.clear();
      for (const id of oldSel) if (validIds.has(id)) selectedAccounts.add(id);

      leftCol.innerHTML = '';
      rightCol.innerHTML = '';

      if (!allAccounts.length) { container.style.display = 'none'; return; }

      const mid = Math.ceil(allAccounts.length / 2);
      const leftAcc = allAccounts.slice(0, mid);
      const rightAcc = allAccounts.slice(mid);

      const render = (accounts, col) => {
        accounts.forEach(a => {
          const id = String(a.id);
          const isHidden = hiddenAccountIds.has(id);

          const item = document.createElement('label');
          item.className = 'account-item';

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.dataset.accountId = id;
          cb.checked = selectedAccounts.has(id);
          cb.onchange = () => {
            if (cb.checked) selectedAccounts.add(id);
            else selectedAccounts.delete(id);
            saveSettings();
          };

          const text = document.createElement('span');
          text.textContent = `${id} â€” ${a.name || ''}${isHidden ? ' (hidden)' : ''}`;

          item.appendChild(cb);
          item.appendChild(text);
          col.appendChild(item);
        });
      };

      render(leftAcc, leftCol);
      render(rightAcc, rightCol);

      container.style.display = 'block';
      $('accountCount').textContent = `${allAccounts.length}`;

      // Initialize resize after accounts rendered
      setTimeout(initAccountsResizeHandle, 100);
    }

    window.selectAllAccounts = () => {
      selectedAccounts = new Set(allAccounts.map(a => String(a.id)));
      document.querySelectorAll('[data-account-id]').forEach(cb => cb.checked = true);
      saveSettings();
    };

    window.selectActiveAccounts = () => {
      selectedAccounts.clear();
      document.querySelectorAll('[data-account-id]').forEach(cb => {
        const id = cb.dataset.accountId;
        const isActive = !hiddenAccountIds.has(id);
        cb.checked = isActive;
        if (isActive) selectedAccounts.add(id);
      });
      saveSettings();
    };

    window.clearAccounts = () => {
      selectedAccounts.clear();
      document.querySelectorAll('[data-account-id]').forEach(cb => cb.checked = false);
      saveSettings();
    };

    // ============================================================================
    // COLUMN TOGGLES
    // ============================================================================
    window.toggleGroup = (group, checked) => {
      document.querySelectorAll(`.col-${group}`).forEach(cb => cb.checked = checked);
      saveSettings();
    };

    // ============================================================================
    // RUN
    // ============================================================================
    $('runBtn').onclick = async () => {
      if (isLocked) return;

      const apiKey = $('apiKey').value || localStorage.getItem(KEY_STORE);
      if (!apiKey) {
        setStatus('Error', 'error');
        log('ERROR: No API key');
        showToast('Enter API key', 'error');
        openDrawer('api');
        return;
      }

      if (!selectedAccounts.size && !$('manualAccountIds').value.trim()) {
        setStatus('Error', 'error');
        log('ERROR: No accounts');
        showToast('Select accounts', 'error');
        openDrawer('accounts');
        return;
      }

      const searchType = $('searchTypeDropdown').value;
      const isPhoneSearch = searchType === 'phone';
      const isBulkExport = searchType === 'bulk-export';

      if (isPhoneSearch && !$('phoneNumbers').value.trim()) {
        setStatus('Error', 'error');
        log('ERROR: No phone numbers');
        showToast('Enter phone numbers', 'error');
        return;
      }

      const startDate = $('startDate').value;
      const endDate = $('endDate').value;

      if (!startDate || !endDate) {
        setStatus('Error', 'error');
        log('ERROR: No date range');
        showToast('Set date range', 'error');
        return;
      }

      const selectedCols = Array.from(document.querySelectorAll('.col-check:checked')).map(cb => cb.value);
      const includeCaller = selectedCols.includes('caller_number');
      const includeMessageMeta = selectedCols.includes('message_id') || selectedCols.includes('message_name');

      currentJobId = `job_${Date.now()}`;
      setLocked(true);
      setStatus('Running...', 'running');

      const taskName = isPhoneSearch ? 'Search' : isBulkExport ? 'Export' : 'Combine';
      log(`Starting ${taskName}...`);

      if (eventSource) eventSource.close();
      eventSource = new EventSource(`/api/stream/${currentJobId}`);

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'log') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${time}] ${data.message}`;
            $('logContent').appendChild(entry);
            $('logContent').scrollTop = $('logContent').scrollHeight;
          } else if (data.type === 'progress') {
            updateProgress(data.current, data.total, data.text);
          }
        } catch (e) {}
      };

      eventSource.onerror = () => {
        if (eventSource) { eventSource.close(); eventSource = null; }
      };

      const accountIds = new Set(selectedAccounts);
      const manualIds = $('manualAccountIds').value.trim();
      if (manualIds) {
        manualIds.split(',').forEach(id => {
          const t = id.trim();
          if (t) accountIds.add(t);
        });
      }

      const clientPrefix = ($('clientPrefix')?.value || '').trim();

      const payload = {
        job_id: currentJobId,
        api_key: apiKey,
        account_ids: Array.from(accountIds),
        start_date: startDate,
        end_date: endDate,
        include_caller: includeCaller,
        include_message_meta: includeMessageMeta,
        output_mode: outputMode
      };

      // Client prefix only applies to phone search, combine campaigns, and trend analyzer
      // NOT to bulk-export (individual campaign exports don't need client prefix)
      if (searchType !== 'bulk-export' && clientPrefix) {
        payload.client_prefix = clientPrefix;
      }

      if (isPhoneSearch) {
        payload.numbers = $('phoneNumbers').value.trim().split(/[\n,]+/).map(s => s.trim()).filter(Boolean);
      }

      // Check if "With Combine" radio is selected for trend analysis
      const trendSource = document.querySelector('input[name="trendSource"]:checked')?.value;
      if (searchType === 'combine' && trendSource === 'combine') {
        payload.generate_trend_analysis = true;
        payload.min_consec_unsuccessful = parseInt($('minConsecUnsuccessful').value) || 4;
        payload.min_run_span_days = parseInt($('minRunSpanDays').value) || 30;
      }

      let endpoint = '/api/search';
      if (searchType === 'combine') endpoint = '/api/combine';
      if (searchType === 'bulk-export') endpoint = '/api/bulk-export';

      try {
        const resp = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data.error || 'Failed');

        setLocked(false);
        setStatus('Done', 'done');
        playCompletionSound();

        let summary = '';
        if (searchType === 'bulk-export') {
          const s = data.stats || {};
          const downloaded = s.exported || s.successfulDownloads || 0;
          const failed = s.failed || s.failedDownloads || 0;
          const totalRecords = s.totalRows || s.totalRecords || 0;
          summary = `${downloaded} campaigns, ${totalRecords} rows`;
          log('');
          log(`âœ“ Complete: ${downloaded} campaigns, ${failed} failed, ${totalRecords} rows`);
        } else {
          const count = data.matches || data.totalRows || 0;
          summary = `${count} results`;
          log('');
          log(`âœ“ Complete: ${count} results`);
        }

        showToast(`${taskName}: ${summary}`, 'success', 5000);

        if (outputMode === 'database' || outputMode === 'both') {
          await refreshDatabaseStats();
        }

        if (window.voapps) await refreshArtifacts();
      } catch(e) {
        setLocked(false);
        setStatus('Error', 'error');
        log(`ERROR: ${e.message}`);
        showToast(`Failed: ${e.message}`, 'error', 5000);
      } finally {
        if (eventSource) { eventSource.close(); eventSource = null; }
        currentJobId = null;
      }
    };

    $('pauseBtn').onclick = async () => {
      if (!currentJobId) return;

      if (isPaused) {
        log('Resuming...');
        isPaused = false;
        $('pauseBtn').innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>Pause';
        setStatus('Running...', 'running');
        await fetch('/api/resume', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ job_id: currentJobId }) });
      } else {
        log('Pausing...');
        isPaused = true;
        $('pauseBtn').innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>Resume';
        setStatus('Paused', 'idle');
        await fetch('/api/pause', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ job_id: currentJobId }) });
      }
    };

    $('cancelBtn').onclick = cancelOperation;

    $('quitBtn').onclick = async () => {
      log('Quitting...');
      try { await fetch('/api/shutdown', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' }); } catch(e) {}
    };

    $('clearLogBtn').onclick = () => {
      $('logContent').innerHTML = '';
      log('Cleared');
    };

    // ============================================================================
    // HELPERS
    // ============================================================================
    function playCompletionSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 880;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);
      } catch (e) {}
    }

    async function refreshArtifacts() {
      if (!window.voapps?.getLastArtifacts) return;

      try {
        const r = await window.voapps.getLastArtifacts();
        if (!r.ok) return;

        const { csvPath, logPath, errorPath, analysisPath } = r.artifacts || {};

        if (csvPath) {
          $('csvPath').textContent = csvPath;
          $('openCsvBtn').disabled = false;
          $('openCsvBtn').onclick = async () => {
            const res = await window.voapps.openPath(csvPath);
            if (!res.ok) log(`Failed: ${res.error}`);
          };
        }

        if (logPath) {
          $('logPath').textContent = logPath;
          $('openLogBtn').disabled = false;
          $('openLogBtn').onclick = async () => {
            const res = await window.voapps.openPath(logPath);
            if (!res.ok) log(`Failed: ${res.error}`);
          };
        }

        if (analysisPath) {
          $('analysisPath').textContent = analysisPath;
          $('analysisPathRow').style.display = 'flex';
          $('openAnalysisBtn').style.display = 'inline-flex';
          $('openAnalysisBtn').disabled = false;
          $('openAnalysisBtn').onclick = async () => {
            const res = await window.voapps.openPath(analysisPath);
            if (!res.ok) log(`Failed: ${res.error}`);
          };
        }

        if (errorPath) {
          $('openErrorsBtn').disabled = false;
          $('openErrorsBtn').onclick = async () => {
            const res = await window.voapps.openPath(errorPath);
            if (!res.ok) log(`Failed: ${res.error}`);
          };
        }
      } catch(e) {
        log(`Artifact error: ${e.message}`);
      }
    }

    // ============================================================================
    // MODALS
    // ============================================================================
    window.showInfoModal = (id) => {
      const modal = $(`${id}Modal`);
      if (modal) modal.classList.add('visible');
    };

    window.hideInfoModal = (id) => {
      const modal = $(`${id}Modal`);
      if (modal) modal.classList.remove('visible');
    };

    window.toggleHelp = () => showInfoModal('help');

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Close modals first
        document.querySelectorAll('.info-modal.visible').forEach(m => m.classList.remove('visible'));
        // Then close drawers
        closeDrawer();
      }
    });

    // ============================================================================
    // UPDATES
    // ============================================================================
    window.checkForUpdates = async (silent = false) => {
      if (!window.voapps?.checkForUpdates) {
        if (!silent) showToast('Updates not available', 'info');
        return;
      }

      const modal = $('updateModal');
      const title = $('updateModalTitle');
      const body = $('updateModalBody');

      if (!silent) {
        title.textContent = 'Checking...';
        body.innerHTML = '<p>Please wait...</p>';
        modal.classList.add('visible');
      }

      try {
        const result = await window.voapps.checkForUpdates();

        if (!result.ok) {
          if (!silent) {
            title.textContent = 'Error';
            body.innerHTML = `<p>${result.error}</p>`;
          }
          return;
        }

        if (result.updateAvailable) {
          title.textContent = `v${result.latestVersion} Available`;
          body.innerHTML = `
            <p>Current: v${result.currentVersion}</p>
            <p>Latest: v${result.latestVersion}</p>
            <button onclick="downloadUpdate('${result.downloadUrl}')" class="btn btn-primary" style="width:100%;margin-top:12px;">Download</button>
          `;
          modal.classList.add('visible');
        } else if (!silent) {
          title.textContent = 'Up to Date';
          body.innerHTML = `<p style="font-size:14px;">v${result.currentVersion} is the latest version!</p><p style="margin-top:8px;font-size:24px;text-align:center;">ðŸŽ‰</p>`;
        }
      } catch (e) {
        if (!silent) {
          title.textContent = 'Error';
          body.innerHTML = `<p>${e.message}</p>`;
        }
      }
    };

    window.downloadUpdate = async (url) => {
      if (window.voapps?.openUpdateUrl) await window.voapps.openUpdateUrl(url);
      else window.open(url, '_blank');
    };

    // ============================================================================
    // SETTINGS
    // ============================================================================
    function loadSettings() {
      const saved = localStorage.getItem(SETTINGS_STORE);
      if (!saved) return;

      try {
        const s = JSON.parse(saved);

        if (s.logLevel) $('logLevel').value = s.logLevel;
        if (s.startDate) $('startDate').value = s.startDate;
        if (s.endDate) $('endDate').value = s.endDate;

        if (s.searchType) {
          $('searchTypeDropdown').value = s.searchType;
          $('searchTypeDescription').textContent = searchTypeDescriptions[s.searchType] || "";
          $('phoneInputContainer').classList.toggle('visible', s.searchType === 'phone');
          $('trendAnalyzerContainer').classList.toggle('visible', s.searchType === 'combine');

          const runBtn = $('runBtn');
          if (s.searchType === 'bulk-export') runBtn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Export';
          else if (s.searchType === 'combine') runBtn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>Combine';
          else runBtn.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>Run';
        }

        if (s.selectedAccounts) selectedAccounts = new Set(s.selectedAccounts);

        if (s.selectedColumns) {
          document.querySelectorAll('.col-check').forEach(cb => {
            cb.checked = s.selectedColumns.includes(cb.value);
          });
        }

        if (s.manualAccountIds) $('manualAccountIds').value = s.manualAccountIds;

        // Trend source radio button is handled by initTrendSourceUI()

        if (s.minConsecUnsuccessful) $('minConsecUnsuccessful').value = s.minConsecUnsuccessful;
        if (s.minRunSpanDays) $('minRunSpanDays').value = s.minRunSpanDays;

        if (s.outputMode) setOutputMode(s.outputMode);
        if (s.clientPrefix && $('clientPrefix')) $('clientPrefix').value = s.clientPrefix;
      } catch (e) {}
    }

    function saveSettings() {
      const trendSource = document.querySelector('input[name="trendSource"]:checked')?.value || 'combine';
      const s = {
        logLevel: $('logLevel')?.value || 'normal',
        startDate: $('startDate').value,
        endDate: $('endDate').value,
        searchType: $('searchTypeDropdown').value,
        selectedAccounts: Array.from(selectedAccounts),
        selectedColumns: Array.from(document.querySelectorAll('.col-check:checked')).map(cb => cb.value),
        manualAccountIds: $('manualAccountIds')?.value || '',
        trendSource: trendSource,
        minConsecUnsuccessful: parseInt($('minConsecUnsuccessful').value) || 4,
        minRunSpanDays: parseInt($('minRunSpanDays').value) || 30,
        outputMode: outputMode,
        clientPrefix: $('clientPrefix')?.value || ''
      };
      localStorage.setItem(SETTINGS_STORE, JSON.stringify(s));
    }

    // ============================================================================
    // INIT
    // ============================================================================
    (async () => {
      log('VoApps Tools v3.1.0');

      loadSettings();
      initLogFilter();
      initHomeResizeHandle();
      initTrendSourceUI();
      loadAccountsFromCache(); // Restore cached accounts if available

      try {
        const r = await fetch('/api/ping');
        if (r.ok) {
          log('Server connected');
          await refreshArtifacts();
          if (outputMode === 'database' || outputMode === 'both') {
            await refreshDatabaseStats();
          }
        }
      } catch {
        log('Server offline');
      }

      setTimeout(() => checkForUpdates(true), 3000);
    })();

    setTimeout(() => showToast('Ready', 'success', 2000), 800);
  </script>
</body>
</html>
