<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VoApps Tools</title>
  <style>
    :root{
      --pink:#FF4B7D;
      --indigo:#3F2FB8;
      --ink:#0D0B1E;
      --text:#2A2A2A;
      --muted:#6B6B6B;
      --card:#FFFFFFCC;
      --card2:#FFFFFFE6;
      --stroke:#E7E7F0;
      --shadow: 0 18px 55px rgba(25, 18, 60, .12);
      --shadow2: 0 10px 30px rgba(25, 18, 60, .10);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: "Montserrat", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(255,75,125,.30), transparent 60%),
        radial-gradient(1000px 650px at 85% 20%, rgba(63,47,184,.25), transparent 55%),
        linear-gradient(135deg, #F8F5FF, #F6F8FF 35%, #F9F7FF);
      overflow:hidden; /* IMPORTANT: no page scroll */
    }

    /* App frame */
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:18px 18px 14px;
      gap:14px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 14px;
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.55));
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:320px;
    }
    .brandMark{
      width:14px; height:14px;
      border-radius:4px;
      background:linear-gradient(135deg, var(--pink), var(--indigo));
      box-shadow: 0 10px 25px rgba(255,75,125,.25);
    }
    .brandTitle{
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      align-items:baseline;
      gap:6px;
    }
    .brandTitle .vo{ color:var(--pink); }
    .brandTitle .tools{ color:var(--indigo); }
    .pill{
      font-size:12px;
      color:#3C3C3C;
      background:#FFFFFFB3;
      border:1px solid var(--stroke);
      padding:4px 10px;
      border-radius:999px;
      margin-left:10px;
    }
    .rightPills{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .statusPill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:#FFFFFFB3;
      font-size:12px;
      color:#3C3C3C;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background:#9AA0A6;
    }
    .dot.ok{ background:#23C55E; box-shadow: 0 0 0 4px rgba(35,197,94,.15); }
    .dot.bad{ background:#EF4444; box-shadow: 0 0 0 4px rgba(239,68,68,.15); }

    /* Main grid (no vertical scrolling) */
    .grid{
      flex:1;
      display:grid;
      grid-template-columns: 560px 1fr; /* wider left like your screenshot; right fills */
      gap:14px;
      min-height:0; /* allow children to size without overflow */
    }

    .card{
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      background:linear-gradient(180deg, var(--card2), var(--card));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      min-height:0;
      overflow:hidden;
    }

    /* Left panel */
    .left{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .leftHeader{
      padding:16px 18px 10px;
      border-bottom:1px solid rgba(231,231,240,.8);
    }
    .h1{
      font-size:20px;
      font-weight:800;
      margin:0;
      color:var(--ink);
    }
    .sub{
      margin:6px 0 0;
      font-size:12.5px;
      color:var(--muted);
      line-height:1.35;
    }
    .leftBody{
      padding:14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      overflow:hidden; /* no scrolling inside left */
    }

    .section{
      border:1px solid rgba(231,231,240,.9);
      border-radius:var(--radius2);
      background:#FFFFFFCC;
      padding:12px 12px 10px;
    }
    .sectionTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .sectionTitle{
      font-size:13px;
      font-weight:800;
      color:#222;
      margin:0;
    }
    .sectionHint{
      font-size:11.5px;
      color:var(--muted);
      margin:0;
      text-align:right;
      line-height:1.25;
    }

    .row{ display:flex; gap:10px; align-items:center; }
    label{
      font-size:12px;
      font-weight:700;
      color:#333;
      display:block;
      margin-bottom:6px;
    }

    input[type="text"], input[type="password"], input[type="date"], select, textarea{
      width:100%;
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
      background:#fff;
      box-shadow: 0 6px 18px rgba(25,18,60,.04);
    }
    textarea{
      height:84px;
      resize:none;
      font-family:var(--sans);
      line-height:1.25;
    }
    .btnRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .btn{
      border:1px solid rgba(0,0,0,.06);
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      background:#fff;
      box-shadow: 0 10px 22px rgba(25,18,60,.08);
      transition: transform .06s ease, box-shadow .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); box-shadow: 0 6px 14px rgba(25,18,60,.10); }
    .btnPrimary{
      background: linear-gradient(135deg, var(--pink), #FF6B98);
      color:white;
      border-color: rgba(255,255,255,.25);
    }
    .btnGhost{
      background:#fff;
      color:#2E2E2E;
    }
    .btnSmall{
      padding:7px 10px;
      font-size:12px;
      border-radius:10px;
      box-shadow:none;
    }
    .btn.disabled, .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none !important;
      box-shadow: none !important;
    }

    .toggleRow{
      display:flex;
      gap:14px;
      align-items:center;
      margin-top:2px;
      flex-wrap:wrap;
    }
    .check{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12.5px;
      color:#333;
    }
    .check input{ width:16px; height:16px; }

    /* Right panel */
    .right{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .rightHeader{
      padding:16px 18px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(231,231,240,.8);
    }
    .rightTitle{
      margin:0;
      font-size:14px;
      font-weight:900;
      color:#222;
    }
    .rightActions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .mutedSmall{
      font-size:11.5px;
      color:var(--muted);
      margin:0;
      line-height:1.25;
    }

    .rightBody{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    .statusBox{
      border:1px solid rgba(231,231,240,.9);
      border-radius:var(--radius2);
      background:#FFFFFFCC;
      padding:12px;
    }
    .statusLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .statusBig{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color:#222;
    }
    .badge{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:#fff;
      color:#333;
      font-weight:800;
    }
    .badge.idle{ background:#F6F7FF; }
    .badge.run{ background:#FFF1F7; border-color: rgba(255,75,125,.30); }
    .badge.done{ background:#ECFDF3; border-color: rgba(35,197,94,.30); }

    .artifact{
      font-size:12px;
      color:#333;
      margin:0;
      display:flex;
      gap:8px;
      align-items:baseline;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .artifact code{
      font-family:var(--mono);
      font-size:11px;
      color:#222;
      background:rgba(0,0,0,.04);
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(0,0,0,.06);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      display:inline-block;
      max-width: 100%;
    }

    .logWrap{
      flex:1;
      min-height:0;
      border-radius:var(--radius2);
      border:1px solid rgba(231,231,240,.9);
      background: linear-gradient(180deg, #0D1020, #0B0E1A);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .logHeader{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color:#D7DAE5;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .logHeader strong{ color:#FFFFFF; }
    .log{
      padding:10px 12px;
      color:#E9ECF5;
      font-family:var(--mono);
      font-size:11.5px;
      line-height:1.35;
      overflow:auto;
      white-space:pre-wrap;
      flex:1;
      min-height:0;
    }

    /* Footer */
    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:0 6px;
      color:rgba(0,0,0,.45);
      font-size:11.5px;
    }
    .footerRight{ opacity:.7; }

    /* Make sure everything fits without scroll on common displays */
    @media (max-height: 820px){
      textarea{ height:72px; }
      .section{ padding:11px; }
      .leftHeader, .rightHeader{ padding:14px 16px 10px; }
    }
    @media (max-height: 740px){
      textarea{ height:62px; }
      .sub{ display:none; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="brandMark" aria-hidden="true"></div>
        <div class="brandTitle">
          <span class="vo">VoApps</span>
          <span class="tools">Tools</span>
          <span class="pill">Local Mac Utility</span>
        </div>
      </div>

      <div class="rightPills">
        <div class="statusPill" title="Window status">
          <span id="modeDot" class="dot"></span>
          <span id="modeText">Idle</span>
        </div>
        <div class="statusPill" title="Server status">
          <span id="srvDot" class="dot"></span>
          <span>Server:</span>
          <span id="srvText">Checking…</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card left">
        <div class="leftHeader">
          <h1 class="h1">VoApps Tools</h1>
          <p class="sub">
            Search VoApps campaign results across accounts & campaigns for one or more phone numbers.
          </p>
        </div>

        <div class="leftBody">
          <!-- 1. API KEY -->
          <div class="section">
            <div class="sectionTop">
              <div>
                <p class="sectionTitle">1. API Key</p>
              </div>
              <p class="sectionHint">Stored locally on this machine</p>
            </div>

            <label for="apiKey">VoApps API Key</label>
            <div class="row">
              <input id="apiKey" type="password" placeholder="Paste your API key here…" autocomplete="off" />
              <button id="saveKeyBtn" class="btn btnSmall btnGhost">Save</button>
              <button id="clearKeyBtn" class="btn btnSmall btnGhost">Clear</button>
            </div>
          </div>

          <!-- 2. DATE RANGE -->
          <div class="section">
            <div class="sectionTop">
              <p class="sectionTitle">2. Date Range</p>
              <p class="sectionHint">Custom range (MM/DD/YYYY shown)</p>
            </div>

            <div class="row">
              <div style="flex:1;">
                <label for="startDate">Start date</label>
                <input id="startDate" type="date" />
              </div>
              <div style="flex:1;">
                <label for="endDate">End date</label>
                <input id="endDate" type="date" />
              </div>
            </div>
          </div>

          <!-- 3. ACCOUNTS (placeholder) -->
          <div class="section">
            <div class="sectionTop">
              <p class="sectionTitle">3. Accounts</p>
              <p class="sectionHint">Next: load + filter accounts</p>
            </div>

            <div class="row" style="justify-content:space-between;">
              <button id="loadAccountsBtn" class="btn btnSmall btnGhost">Load accounts</button>
              <span class="mutedSmall" id="acctCount">Not loaded yet</span>
            </div>

            <div class="btnRow" style="margin-top:8px;">
              <button id="selectAllBtn" class="btn btnSmall btnGhost disabled" disabled>Select all</button>
              <button id="selectActiveBtn" class="btn btnSmall btnGhost disabled" disabled>Select active</button>
              <button id="clearSelectionBtn" class="btn btnSmall btnGhost disabled" disabled>Clear selection</button>
            </div>
          </div>

          <!-- 4. REPORT TYPE -->
          <div class="section">
            <div class="sectionTop">
              <p class="sectionTitle">4. Report Type</p>
              <p class="sectionHint">Number Search (this tool)</p>
            </div>

            <label for="numbers">Phone numbers (one per line or comma-separated)</label>
            <textarea id="numbers" placeholder="e.g. 4353137000&#10;8015551212"></textarea>

            <div class="toggleRow">
              <label class="check" title="If the results include voapps_caller_number, use that (preferred).">
                <input id="includeCaller" type="checkbox" checked />
                Include caller number (prefers <b>voapps_caller_number</b>)
              </label>

              <label class="check" title="Include message_name and message_description when message_id is present.">
                <input id="includeMessageMeta" type="checkbox" checked />
                Include message metadata (message_name, message_description)
              </label>
            </div>
          </div>

          <!-- 5. RUN -->
          <div class="section">
            <div class="sectionTop">
              <p class="sectionTitle">5. Run</p>
              <p class="sectionHint">Writes files to disk and opens directly</p>
            </div>

            <div class="btnRow">
              <button id="runBtn" class="btn btnPrimary">Run</button>
              <button id="openCsvBtn" class="btn btnGhost disabled" disabled>Open CSV</button>
              <button id="openLogBtn" class="btn btnGhost disabled" disabled>Open Log</button>
            </div>

            <p class="mutedSmall" style="margin:8px 0 0;">
              Tip: This app runs locally on your computer. Results are written to disk and opened from Finder.
            </p>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card right">
        <div class="rightHeader">
          <div>
            <p class="rightTitle">Search status</p>
            <p class="mutedSmall" id="statusText">Idle</p>
          </div>
          <div class="rightActions">
            <button id="clearLogBtn" class="btn btnSmall btnGhost">Clear log</button>
            <button id="pingBtn" class="btn btnSmall btnGhost">Ping</button>
          </div>
        </div>

        <div class="rightBody">
          <div class="statusBox">
            <div class="statusLine">
              <div class="statusBig">
                <span id="statusDot" class="dot ok"></span>
                <span id="statusTitle">Ready</span>
              </div>
              <span id="modeBadge" class="badge idle">Idle</span>
            </div>

            <p class="artifact"><b>Last CSV:</b> <code id="csvPath">—</code></p>
            <p class="artifact"><b>Last Log:</b> <code id="logPath">—</code></p>
          </div>

          <div class="logWrap">
            <div class="logHeader">
              <strong>Live Log</strong>
              <span id="logHint">Progress + logs</span>
            </div>
            <div id="log" class="log"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>VoApps Internal Tools</div>
      <div class="footerRight">DirectDrop Voicemail™</div>
    </div>
  </div>

  <script>
    // ------------------------------------------------------------
    // Small polished UI behaviors (safe even before wiring endpoints)
    // ------------------------------------------------------------
    const $ = (id) => document.getElementById(id);

    const logEl = $("log");
    const srvDot = $("srvDot");
    const srvText = $("srvText");
    const modeDot = $("modeDot");
    const modeText = $("modeText");

    const statusText = $("statusText");
    const statusTitle = $("statusTitle");
    const statusDot = $("statusDot");
    const modeBadge = $("modeBadge");

    const csvPathEl = $("csvPath");
    const logPathEl = $("logPath");

    function ts(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${hh}:${mm}:${ss}`;
    }

    function appendLog(line){
      logEl.textContent += `[${ts()}] ${line}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setMode(label, kind){
      modeText.textContent = label;
      modeDot.className = "dot " + (kind === "ok" ? "ok" : kind === "bad" ? "bad" : "");
    }

    function setStatus(title, subtitle, badge, badgeClass){
      statusTitle.textContent = title;
      statusText.textContent = subtitle;
      modeBadge.textContent = badge;
      modeBadge.className = "badge " + (badgeClass || "idle");
    }

    // Local key persistence (renderer-side)
    const KEY_STORE = "voapps_api_key";
    const apiKey = $("apiKey");

    apiKey.value = localStorage.getItem(KEY_STORE) || "";

    $("saveKeyBtn").addEventListener("click", () => {
      localStorage.setItem(KEY_STORE, apiKey.value || "");
      appendLog("[ui] API key saved locally.");
    });

    $("clearKeyBtn").addEventListener("click", () => {
      apiKey.value = "";
      localStorage.removeItem(KEY_STORE);
      appendLog("[ui] API key cleared.");
    });

    // Default dates (today -> today)
    const today = new Date();
    const iso = (d) => d.toISOString().slice(0,10);
    $("startDate").value = iso(new Date(today.getFullYear(), today.getMonth(), 1));
    $("endDate").value = iso(today);

    // Ping server
    async function ping(){
      try{
        const r = await fetch("/ping", { cache: "no-store" });
        const ok = r.ok;
        srvText.textContent = ok ? "Connected" : "Error";
        srvDot.className = "dot " + (ok ? "ok" : "bad");
        setMode(ok ? "Idle" : "Offline", ok ? "ok" : "bad");
        return ok;
      }catch(e){
        srvText.textContent = "Offline";
        srvDot.className = "dot bad";
        setMode("Offline", "bad");
        return false;
      }
    }

    $("pingBtn").addEventListener("click", async () => {
      appendLog("[ui] Ping…");
      const ok = await ping();
      appendLog(ok ? "[ui] Ping: OK" : "[ui] Ping: FAILED");
    });

    $("clearLogBtn").addEventListener("click", () => {
      logEl.textContent = "";
      appendLog("[ui] Log cleared.");
    });

    // Artifact refresh + Electron openPath bridge
    async function refreshArtifacts(){
      if (!window.voapps || !window.voapps.getLastArtifacts) {
        appendLog("[ui] Electron bridge not ready (preload).");
        return;
      }
      const r = await window.voapps.getLastArtifacts();
      if (!r.ok){
        appendLog("[ui] getLastArtifacts error: " + (r.error || "unknown"));
        return;
      }
      const { csvPath, logPath } = r.artifacts || {};

      if (csvPath){
        csvPathEl.textContent = csvPath;
        const b = $("openCsvBtn");
        b.classList.remove("disabled"); b.disabled = false;
        b.onclick = async () => {
          appendLog("[ui] Opening CSV…");
          const rr = await window.voapps.openPath(csvPath);
          if (!rr.ok) appendLog("[ui] Open CSV failed: " + rr.error);
        };
      }
      if (logPath){
        logPathEl.textContent = logPath;
        const b = $("openLogBtn");
        b.classList.remove("disabled"); b.disabled = false;
        b.onclick = async () => {
          appendLog("[ui] Opening Log…");
          const rr = await window.voapps.openPath(logPath);
          if (!rr.ok) appendLog("[ui] Open Log failed: " + rr.error);
        };
      }
    }

    // Run (wired to your current /run stub for now)
    $("runBtn").addEventListener("click", async () => {
      setStatus("Running…", "Working…", "Running", "run");
      appendLog("[ui] Run clicked.");
      try{
        const payload = {
          api_key: localStorage.getItem(KEY_STORE) || "",
          numbers: $("numbers").value || "",
          start_date: $("startDate").value,
          end_date: $("endDate").value,
          include_caller: !!$("includeCaller").checked,
          include_message_meta: !!$("includeMessageMeta").checked
        };

        const resp = await fetch("/run", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        if (!resp.ok){
          throw new Error("Server returned " + resp.status);
        }

        setStatus("Done", "Artifacts updated.", "Done", "done");
        appendLog("[ui] Done. Refreshing artifacts…");
        await refreshArtifacts();
      }catch(e){
        setStatus("Error", String(e.message || e), "Error", "idle");
        statusDot.className = "dot bad";
        appendLog("[ui] ERROR: " + (e.message || e));
      }
    });

    // Initial boot
    (async () => {
      appendLog("[ui] VoApps Tools UI loaded.");
      const ok = await ping();
      if (ok) {
        await refreshArtifacts();
      }
    })();
  </script>
</body>
</html>
